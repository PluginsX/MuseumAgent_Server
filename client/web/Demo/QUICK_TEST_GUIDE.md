# 快速测试指南

## 🔄 测试前准备

1. **强制刷新页面**：按 `Ctrl + F5`（Windows）或 `Cmd + Shift + R`（Mac）
2. **打开开发者工具**：按 `F12`
3. **切换到 Console 标签**
4. **清空控制台**：点击 🚫 图标

## ✅ 测试 1：退格键功能

### 测试步骤
1. 长按控制按钮，选择"聊天"
2. 在输入框输入：`测试退格键功能`
3. 按 `Backspace` 键多次
4. **预期结果**：文字可以正常删除

### 测试步骤 2
1. 长按控制按钮，选择"设置"
2. 展开"智能体角色配置"
3. 在"角色描述"文本框中输入一些文字
4. 按 `Backspace` 键
5. **预期结果**：文字可以正常删除

### 检查日志
```
[App] 已设置键盘事件保护，防止 Unity 捕获输入框事件
```

---

## ✅ 测试 2：语音按钮状态同步

### 测试步骤
1. 点击控制按钮（🎤）开始录音
2. **预期**：按钮变为 ⏹️
3. 长按控制按钮，选择"聊天"打开聊天窗口
4. **预期**：聊天窗口的语音按钮也显示为 ⏹️
5. 点击聊天窗口的语音按钮停止录音
6. **预期**：两个按钮都变回 🎤

### 检查日志
```
[ChatWindow] show() 被调用
[ChatWindow] 同步语音按钮状态：录音中
```

---

## ✅ 测试 3：消息气泡位置

### 测试步骤 1：文本消息
1. 打开聊天窗口
2. 输入：`你好`
3. 点击发送
4. **预期**：
   - 你的消息在右侧（绿色背景）
   - 服务器回复在左侧（白色背景）

### 检查日志（发送）
```
[AgentController] 创建发送消息: {id: "...", type: "sent", messageType: "text"}
[MessageBubble] 渲染气泡: {type: "sent", isSent: true}
```

### 检查日志（接收）
```
[AgentController] 文本块: {messageId: "xxx", chunk: "..."}
[AgentController] 创建接收消息（文本）: {id: "xxx_text", type: "received"}
[MessageBubble] 渲染气泡: {type: "received", isSent: false}
```

### 测试步骤 2：语音消息
1. 点击语音按钮开始录音
2. 说话几秒钟
3. 再次点击停止录音
4. **预期**：
   - 你的语音消息在右侧
   - 服务器的文本回复在左侧（独立气泡）
   - 服务器的语音回复在左侧（独立气泡）
   - **不会出现文字写入语音气泡的情况**

### 检查日志（语音消息）
```
[AgentController] 创建发送消息: {type: "sent", messageType: "voice"}
[AgentController] 创建接收消息（文本）: {id: "xxx_text", type: "received"}
[AgentController] 创建接收消息（语音）: {id: "xxx_voice", type: "received"}
```

**关键点**：注意 `id` 字段，文本消息应该有 `_text` 后缀，语音消息应该有 `_voice` 后缀

---

## ✅ 测试 4：按钮响应

### 测试步骤
1. 打开聊天窗口
2. 点击发送按钮（不输入内容）
3. **预期日志**：
```
[ChatWindow] 发送按钮被点击
[ChatWindow] sendMessage() 被调用
[ChatWindow] 输入为空，取消发送
```

4. 点击语音按钮
5. **预期日志**：
```
[ChatWindow] 语音按钮被点击，当前录音状态: false
[ChatWindow] toggleVoiceRecording() 被调用
[ChatWindow] 开始录音
```

---

## 🐛 问题排查

### 问题：退格键仍然无效

**检查**：
1. 控制台是否有 `[App] 已设置键盘事件保护` 日志？
   - 如果没有：刷新页面
2. 点击输入框，在控制台运行：
   ```javascript
   document.activeElement.tagName
   ```
   应该返回 `"TEXTAREA"` 或 `"INPUT"`
3. 如果仍然无效，在控制台运行：
   ```javascript
   document.activeElement.addEventListener('keydown', (e) => {
     console.log('输入框收到键盘事件:', e.key);
   });
   ```
   然后按退格键，看是否有日志

### 问题：消息气泡全在右侧

**检查**：
1. 查看控制台日志中的 `[MessageBubble] 渲染气泡`
2. 检查 `type` 字段：
   - 发送的消息应该是 `type: "sent"`
   - 接收的消息应该是 `type: "received"`
3. 检查 `isSent` 字段：
   - 发送的消息应该是 `isSent: true`
   - 接收的消息应该是 `isSent: false`

### 问题：文字写入语音气泡

**检查**：
1. 查看控制台日志中的消息 ID
2. 文本消息应该是：`id: "xxx_text"`
3. 语音消息应该是：`id: "xxx_voice"`
4. 如果两者 ID 相同，说明修复未生效，需要强制刷新

### 问题：语音按钮状态不同步

**检查**：
1. 打开聊天窗口时，控制台是否有：
   ```
   [ChatWindow] 同步语音按钮状态：录音中/未录音
   ```
2. 如果没有，说明 `show()` 方法未执行或修复未生效

---

## 📊 完整测试流程

1. **刷新页面** → 检查 `[App] 已设置键盘事件保护`
2. **测试退格键** → 在聊天输入框和设置面板测试
3. **测试语音按钮同步** → 录音 → 打开聊天 → 检查状态
4. **发送文本消息** → 检查气泡位置和日志
5. **发送语音消息** → 检查气泡位置和日志
6. **检查消息 ID** → 确认有 `_text` 和 `_voice` 后缀

---

## 📝 报告问题模板

如果问题仍然存在，请按以下格式提供信息：

```
### 问题描述
[简要描述问题]

### 操作步骤
1. [第一步]
2. [第二步]
3. ...

### 预期结果
[应该发生什么]

### 实际结果
[实际发生了什么]

### 控制台日志
[粘贴相关日志，特别是带 [ChatWindow]、[AgentController]、[MessageBubble] 前缀的]

### 截图
[如果可能，提供截图]
```

---

## ✨ 修复总结

本次修复解决了以下问题：

1. ✅ **退格键无效** - 添加全局键盘事件保护，防止 Unity 捕获
2. ✅ **语音按钮状态不同步** - 在 `show()` 时同步当前录音状态
3. ✅ **消息气泡混乱** - 为文本和语音消息使用不同的 ID（`_text` 和 `_voice` 后缀）
4. ✅ **按钮无响应** - 在每次 `render()` 后重新绑定 UI 事件

所有修复都已完成，请按照上述步骤进行测试！

