<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIå“åº”ç›‘æ§å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .panel {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .panel h3 {
            margin-top: 0;
            color: #333;
        }
        input, textarea, button, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #000;
            color: #00ff00;
            padding: 10px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .response-data {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .highlight {
            background: yellow;
            padding: 2px 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” APIå“åº”ç›‘æ§å·¥å…·</h1>
        <p>ç”¨äºç›‘æ§å’Œåˆ†æå®é™…çš„APIå“åº”æ•°æ®</p>
        
        <div class="panel">
            <h3>âš™ï¸ é…ç½®è®¾ç½®</h3>
            <label>æœåŠ¡å™¨åœ°å€:</label>
            <input type="text" id="serverUrl" value="http://localhost:8000" style="width: 200px;">
            
            <label>ä¼šè¯ID:</label>
            <input type="text" id="sessionId" placeholder="è¯·è¾“å…¥æœ‰æ•ˆçš„ä¼šè¯ID" style="width: 200px;">
            
            <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="panel">
            <h3>ğŸ“ è¯·æ±‚æµ‹è¯•</h3>
            <label>æµ‹è¯•æ¶ˆæ¯:</label>
            <input type="text" id="testMessage" value="ç§»åŠ¨åˆ°(0ï¼Œ0)" style="width: 300px;">
            <button onclick="sendTestRequest()">å‘é€æµ‹è¯•è¯·æ±‚</button>
            <button onclick="sendDirectRequest()">ç›´æ¥å‘é€è¯·æ±‚</button>
        </div>
        
        <div class="panel">
            <h3>ğŸ“‹ å“åº”æ•°æ®åˆ†æ</h3>
            <button onclick="analyzeLastResponse()">åˆ†ææœ€åå“åº”</button>
            <button onclick="checkFieldIntegrity()">æ£€æŸ¥å­—æ®µå®Œæ•´æ€§</button>
        </div>
        
        <div class="panel">
            <h3>ğŸ“¡ ç½‘ç»œæ—¥å¿—</h3>
            <div id="log" class="log">ç­‰å¾…è¯·æ±‚...</div>
        </div>
        
        <div class="panel">
            <h3>ğŸ“Š æœ€åå“åº”è¯¦æƒ…</h3>
            <div id="responseData" class="response-data">
                å°šæœªæ”¶åˆ°å“åº”
            </div>
        </div>
    </div>

    <script>
        let lastResponse = null;
        let logElement = document.getElementById('log');
        let responseDataElement = document.getElementById('responseData');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.textContent = '';
        }
        
        function updateResponseDisplay(data) {
            lastResponse = data;
            responseDataElement.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        }
        
        async function testConnection() {
            const serverUrl = document.getElementById('serverUrl').value;
            log(`æµ‹è¯•è¿æ¥åˆ°: ${serverUrl}`);
            
            try {
                const response = await fetch(`${serverUrl}/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… è¿æ¥æˆåŠŸ: ${JSON.stringify(data)}`);
                } else {
                    log(`âŒ è¿æ¥å¤±è´¥: HTTP ${response.status}`);
                }
            } catch (error) {
                log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }
        
        async function sendTestRequest() {
            const serverUrl = document.getElementById('serverUrl').value;
            const sessionId = document.getElementById('sessionId').value;
            const message = document.getElementById('testMessage').value;
            
            if (!sessionId) {
                log('âŒ è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„ä¼šè¯ID');
                return;
            }
            
            log(`ğŸ“¤ å‘é€æµ‹è¯•è¯·æ±‚: "${message}"`);
            log(`ğŸ‘¤ ä¼šè¯ID: ${sessionId}`);
            
            try {
                const response = await fetch(`${serverUrl}/api/agent/parse`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'session-id': sessionId
                    },
                    body: JSON.stringify({
                        user_input: message,
                        client_type: 'monitor_tool',
                        scene_type: 'public'
                    })
                });
                
                const data = await response.json();
                log(`ğŸ“¥ æ”¶åˆ°å“åº”: HTTP ${response.status}`);
                log(`ğŸ“„ å“åº”æ•°æ®:`);
                log(JSON.stringify(data, null, 2));
                
                updateResponseDisplay(data);
                
                if (response.ok) {
                    log('âœ… è¯·æ±‚å¤„ç†æˆåŠŸ');
                } else {
                    log(`âŒ è¯·æ±‚å¤„ç†å¤±è´¥: ${data.msg || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
            } catch (error) {
                log(`âŒ è¯·æ±‚é”™è¯¯: ${error.message}`);
            }
        }
        
        async function sendDirectRequest() {
            const serverUrl = document.getElementById('serverUrl').value;
            const sessionId = document.getElementById('sessionId').value;
            const message = document.getElementById('testMessage').value;
            
            log('ğŸ“¤ å‘é€ç›´æ¥è¯·æ±‚ï¼ˆç»•è¿‡å®¢æˆ·ç«¯å¤„ç†ï¼‰');
            
            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${serverUrl}/api/agent/parse`, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                if (sessionId) {
                    xhr.setRequestHeader('session-id', sessionId);
                }
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        log(`ğŸ“¥ XHRå“åº”çŠ¶æ€: ${xhr.status}`);
                        log(`ğŸ“„ åŸå§‹å“åº”å¤´:`);
                        log(xhr.getAllResponseHeaders());
                        
                        try {
                            const data = JSON.parse(xhr.responseText);
                            log(`ğŸ“„ å“åº”æ•°æ®:`);
                            log(xhr.responseText);
                            updateResponseDisplay(data);
                        } catch (e) {
                            log(`ğŸ“„ åŸå§‹å“åº”æ–‡æœ¬:`);
                            log(xhr.responseText);
                        }
                    }
                };
                
                xhr.send(JSON.stringify({
                    user_input: message,
                    client_type: 'direct_monitor',
                    scene_type: 'public'
                }));
                
            } catch (error) {
                log(`âŒ ç›´æ¥è¯·æ±‚é”™è¯¯: ${error.message}`);
            }
        }
        
        function analyzeLastResponse() {
            if (!lastResponse) {
                log('âŒ æ²¡æœ‰å“åº”æ•°æ®å¯ä¾›åˆ†æ');
                return;
            }
            
            log('ğŸ” åˆ†æå“åº”æ•°æ®ç»“æ„:');
            
            if (lastResponse.code === 200 && lastResponse.data) {
                const data = lastResponse.data;
                log('âœ… å“åº”æ ¼å¼æ­£ç¡®');
                
                // æ£€æŸ¥å…³é”®å­—æ®µ
                const keyFields = ['command', 'parameters', 'type', 'format', 'response'];
                keyFields.forEach(field => {
                    if (field in data) {
                        if (data[field] !== null) {
                            log(`âœ… ${field}: ${JSON.stringify(data[field])}`);
                        } else {
                            log(`âš ï¸  ${field}: null`);
                        }
                    } else {
                        log(`âŒ ${field}: ä¸å­˜åœ¨`);
                    }
                });
                
                // æ£€æŸ¥ä¼ ç»Ÿå­—æ®µ
                const traditionalFields = ['artifact_id', 'artifact_name', 'operation', 'operation_params'];
                traditionalFields.forEach(field => {
                    if (field in data) {
                        if (data[field] === null) {
                            log(`âœ… ${field}: null (é¢„æœŸ)`);
                        } else {
                            log(`âš ï¸  ${field}: ${data[field]} (æ„å¤–å€¼)`);
                        }
                    } else {
                        log(`âœ… ${field}: ä¸å­˜åœ¨ (é¢„æœŸ)`);
                    }
                });
                
            } else {
                log('âŒ å“åº”æ ¼å¼é”™è¯¯æˆ–å¤„ç†å¤±è´¥');
                log(`çŠ¶æ€ç : ${lastResponse.code}`);
                log(`æ¶ˆæ¯: ${lastResponse.msg}`);
            }
        }
        
        function checkFieldIntegrity() {
            if (!lastResponse || !lastResponse.data) {
                log('âŒ æ²¡æœ‰æœ‰æ•ˆçš„å“åº”æ•°æ®');
                return;
            }
            
            const data = lastResponse.data;
            log('ğŸ“‹ å­—æ®µå®Œæ•´æ€§æ£€æŸ¥:');
            
            // ç»Ÿè®¡å­—æ®µæƒ…å†µ
            const allFields = Object.keys(data);
            const nullFields = allFields.filter(key => data[key] === null);
            const validFields = allFields.filter(key => data[key] !== null);
            const undefinedFields = allFields.filter(key => !(key in data));
            
            log(`æ€»å­—æ®µæ•°: ${allFields.length}`);
            log(`æœ‰æ•ˆå­—æ®µ: ${validFields.length} (${validFields.join(', ')})`);
            log(`Nullå­—æ®µ: ${nullFields.length} (${nullFields.join(', ')})`);
            log(`æœªå®šä¹‰å­—æ®µ: ${undefinedFields.length}`);
            
            // ç‰¹åˆ«å…³æ³¨å…³é”®å­—æ®µ
            const criticalFields = ['command', 'parameters', 'response'];
            criticalFields.forEach(field => {
                if (field in data) {
                    const status = data[field] === null ? 'âŒ NULL' : 'âœ… æœ‰æ•ˆ';
                    log(`${status} ${field}: ${JSON.stringify(data[field])}`);
                } else {
                    log(`âŒ ç¼ºå¤± ${field}`);
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            log('ğŸ” APIç›‘æ§å·¥å…·å·²å¯åŠ¨');
            log('è¯·å…ˆé…ç½®æœåŠ¡å™¨åœ°å€å’Œä¼šè¯IDï¼Œç„¶åè¿›è¡Œæµ‹è¯•');
        };
    </script>
</body>
</html>