<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšç‰©é¦†æ™ºèƒ½ä½“æµ‹è¯•å®¢æˆ·ç«¯</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #e1e5e9;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* å¤´éƒ¨ */
        header {
            background: var(--card-bg);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 1.2rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e74c3c;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background-color: #27ae60;
        }

        .ssl-badge {
            font-size: 0.7rem;
            color: #27ae60;
            background: #d5f4e6;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #27ae60;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ä¸»ä½“å¸ƒå±€ */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            flex: 1;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            max-height: 100%;
        }

        .config-section {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            flex-shrink: 0;
        }

        .config-section h3 {
            font-size: 0.9rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 0.5rem;
        }

        label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* æŒ‡ä»¤é›†é…ç½®æ ·å¼ */
        #operationCheckboxes {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            background: var(--bg-color);
        }

        #operationCheckboxes div {
            padding: 0.25rem 0;
        }

        #customOperationList {
            font-family: monospace;
            background: var(--bg-color);
        }

        .toast {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .toast-success {
            background: #27ae60;
        }

        .toast-error {
            background: #e74c3c;
        }

        .toast-warning {
            background: #f39c12;
        }

        .toast-info {
            background: #3498db;
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }

        .chat-header {
            padding: 1rem;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            min-height: 0;
            max-height: calc(100vh - 200px);
        }

        .message {
            margin-bottom: 1rem;
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            position: relative;
        }

        .message.user {
            background: var(--secondary-color);
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.bot {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            align-self: flex-start;
        }

        .message-header {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
        }

        .message-content {
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .command-display {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.8rem;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input {
            padding: 1rem;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .input-group {
            flex: 1;
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        textarea {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: none;
            font-size: 1rem;
            font-family: inherit;
            min-height: 40px;
            max-height: 200px;
            line-height: 1.4;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none; /* ç§»åŠ¨ç«¯éšè—ä¾§è¾¹æ ï¼Œå¯è€ƒè™‘æ”¹ä¸ºæŠ˜å  */
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>
            <span class="status-indicator" id="connectionStatus"></span>
            åšç‰©é¦†æ™ºèƒ½ä½“æµ‹è¯•å®¢æˆ·ç«¯
        </h1>
        <div>
            <span id="connectionText">æœªè¿æ¥</span>
        </div>
    </header>

    <div class="container">
        <!-- ä¾§è¾¹æ é…ç½® -->
        <aside class="sidebar">
            <div class="config-section">
                <h3>æœåŠ¡å™¨é…ç½®</h3>
                <div class="form-group">
                    <label for="serverUrl">æœåŠ¡å™¨åœ°å€ <span class="ssl-badge">æ”¯æŒHTTPS</span></label>
                    <input type="text" id="serverUrl" value="https://localhost:8000">
                </div>
                <div class="form-group">
                    <label for="timeout">è¯·æ±‚è¶…æ—¶(ç§’)</label>
                    <input type="number" id="timeout" value="30" min="5" max="120">
                </div>
                <button class="btn" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                <button class="btn btn-secondary" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
            </div>

            <div class="config-section">
                <h3>å®¢æˆ·ç«¯é…ç½®</h3>
                <div class="form-group">
                    <label for="clientType">å®¢æˆ·ç«¯ç±»å‹</label>
                    <select id="clientType" onchange="updateOperationPresets()">
                        <option value="test">æµ‹è¯•å®¢æˆ·ç«¯</option>
                        <option value="web3d">Web3Då±•ç¤ºç«¯</option>
                        <option value="spirit">å™¨çµæ¡Œé¢å® ç‰©</option>
                        <option value="mobile">ç§»åŠ¨ç«¯</option>
                        <option value="api">APIè°ƒç”¨è€…</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="clientId">å®¢æˆ·ç«¯ID</label>
                    <input type="text" id="clientId" placeholder="è‡ªåŠ¨ç”Ÿæˆæˆ–æ‰‹åŠ¨è¾“å…¥">
                </div>
                <div class="form-group">
                    <label for="spiritId">å™¨çµID</label>
                    <input type="text" id="spiritId" placeholder="å¯é€‰">
                </div>
                <div class="form-group">
                    <label for="sceneType">åœºæ™¯ç±»å‹</label>
                    <select id="sceneType">
                        <option value="public">å…¬å…±åœºæ™¯</option>
                        <option value="study">å­¦ä¹ åœºæ™¯</option>
                        <option value="leisure">ä¼‘é—²åœºæ™¯</option>
                    </select>
                </div>
            </div>

            <div class="config-section">
                <h3>æŒ‡ä»¤é›†é…ç½® <span style="font-size: 0.8rem; color: #e74c3c;">âœ¨ æ–°åŠŸèƒ½</span></h3>
                <div class="form-group">
                    <label for="operationMode">æŒ‡ä»¤é›†æ¨¡å¼</label>
                    <select id="operationMode" onchange="toggleOperationConfig()">
                        <option value="preset">é¢„è®¾æ¨¡å¼</option>
                        <option value="custom">è‡ªå®šä¹‰æ¨¡å¼</option>
                    </select>
                </div>
                
                <div id="presetOperations" class="form-group">
                    <label>é¢„è®¾æŒ‡ä»¤é›†</label>
                    <div id="operationCheckboxes">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„é¢„è®¾æŒ‡ä»¤å¤é€‰æ¡† -->
                    </div>
                </div>
                
                <div id="customOperations" class="form-group" style="display: none;">
                    <label for="customOperationList">è‡ªå®šä¹‰æŒ‡ä»¤é›†ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                    <textarea id="customOperationList" rows="4" placeholder="ä¾‹å¦‚ï¼š&#10;zoom_pattern&#10;restore_scene&#10;introduce"></textarea>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="previewCommandSet()">é¢„è§ˆæŒ‡ä»¤é›†</button>
                    <button class="btn" onclick="registerSession()" id="registerBtn">æ³¨å†Œä¼šè¯</button>
                </div>
                
                <div id="sessionInfo" style="display: none;">
                    <div style="background: #d5f4e6; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                        <strong>ä¼šè¯çŠ¶æ€:</strong> <span id="sessionStatus">æœªæ³¨å†Œ</span><br>
                        <strong>ä¼šè¯ID:</strong> <span id="sessionIdDisplay">-</span><br>
                        <strong>è¿‡æœŸæ—¶é—´:</strong> <span id="sessionExpiry">-</span>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3>å¿«é€Ÿè®¿é—®</h3>
                <button class="btn btn-secondary" onclick="window.open(getCurrentServerUrl() + '/Control', '_blank')">ç®¡ç†é¢æ¿</button>
                <button class="btn btn-secondary" onclick="window.open(getCurrentServerUrl() + '/docs', '_blank')">APIæ–‡æ¡£</button>
            </div>

            <div class="config-section">
                <h3>é…ç½®è¯´æ˜</h3>
                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">å„é…ç½®é¡¹è¯´æ˜ï¼š</p>
                <ul style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                    <li>å®¢æˆ·ç«¯ç±»å‹ï¼šå½±å“é¢„è®¾æŒ‡ä»¤é›†çš„é€‰æ‹©</li>
                    <li>æŒ‡ä»¤é›†æ¨¡å¼ï¼šé¢„è®¾æ¨¡å¼ä½¿ç”¨æ ‡å‡†æŒ‡ä»¤é›†ï¼Œè‡ªå®šä¹‰æ¨¡å¼å¯è‡ªç”±é…ç½®</li>
                    <li>æ³¨å†Œä¼šè¯ï¼šåŠ¨æ€æŒ‡ä»¤é›†éœ€è¦å…ˆæ³¨å†Œä¼šè¯æ‰èƒ½ç”Ÿæ•ˆ</li>
                    <li>å™¨çµIDï¼šç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯å¯ä¼ ç©ºï¼ŒæœåŠ¡ç«¯ä¸åšä¸šåŠ¡å¤„ç†</li>
                    <li>åœºæ™¯ç±»å‹ï¼šstudy/leisure/publicï¼Œé»˜è®¤public</li>
                </ul>
            </div>

            <div class="config-section">
                <h3>æ“ä½œç¤ºä¾‹</h3>
                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">ç‚¹å‡»å‘é€æµ‹è¯•æ¶ˆæ¯ï¼š</p>
                <button class="btn btn-secondary" onclick="sendExample('è®²è®²èŸ é¾™ç›–ç½çš„çº¹æ ·')">çº¹æ ·ä»‹ç»</button>
                <button class="btn btn-secondary" onclick="sendExample('æ”¾å¤§æŸ¥çœ‹é’é“œé¼')">æ”¾å¤§æŸ¥çœ‹</button>
                <button class="btn btn-secondary" onclick="sendExample('è¿˜åŸå·ä½“å¤”çº¹èŸ é¾™ç›–ç½çš„åœºæ™¯')">è¿˜åŸåœºæ™¯</button>
                <button class="btn btn-secondary" onclick="sendExample('ä¸èŸ é¾™ç›–ç½çš„å™¨çµå¯¹è¯')">å™¨çµäº¤äº’</button>
                <button class="btn btn-secondary" onclick="sendExample('æŸ¥è¯¢é’é“œé¼çš„å‚æ•°')">æŸ¥è¯¢å‚æ•°</button>
                <button class="btn btn-secondary" onclick="sendExample('æµ‹è¯•HTTPSè¿æ¥')">æµ‹è¯•HTTPS</button>
            </div>
        </aside>

        <!-- èŠå¤©ä¸»åŒºåŸŸ -->
        <main class="chat-container">
            <div class="chat-header">
                <div>
                    <strong>æ™ºèƒ½ä½“å¯¹è¯</strong>
                    <span style="font-size: 0.8rem; color: #666;">(æµ‹è¯•æ¨¡å¼)</span>
                </div>
                <div>
                    <button class="btn btn-danger" onclick="clearChat()">æ¸…ç©º</button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            </div>

            <div class="chat-input">
                <div class="input-group">
                    <textarea 
                        id="userInput" 
                        placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šè®²è®²èŸ é¾™ç›–ç½çš„çº¹æ ·..." 
                        rows="3"></textarea>
                    <button class="btn" onclick="sendMessage()" id="sendBtn">å‘é€</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let isConnected = false;
        let isProcessing = false;
        let sessionId = null;
        let sessionExpiryTime = null;
        let heartbeatInterval = null;

        // DOM å…ƒç´ 
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            initializeOperationSets();
            updateOperationPresets();
            addEventListeners();
            addWelcomeMessage();
        });

        // æ·»åŠ äº‹ä»¶ç›‘å¬
        function addEventListeners() {
            // å›è½¦å‘é€æ¶ˆæ¯
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // è¾“å…¥æ¡†å˜åŒ–æ—¶ä¿å­˜è®¾ç½®
            document.getElementById('serverUrl').addEventListener('change', saveSettings);
            document.getElementById('timeout').addEventListener('change', saveSettings);
            document.getElementById('clientType').addEventListener('change', saveSettings);
            document.getElementById('clientId').addEventListener('change', saveSettings);
            document.getElementById('spiritId').addEventListener('change', saveSettings);
            document.getElementById('sceneType').addEventListener('change', saveSettings);
            document.getElementById('operationMode').addEventListener('change', saveSettings);
            document.getElementById('customOperationList').addEventListener('change', saveSettings);
        }

        // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
        function addWelcomeMessage() {
            addBotMessage("æ¬¢è¿ä½¿ç”¨åšç‰©é¦†æ™ºèƒ½ä½“æµ‹è¯•å®¢æˆ·ç«¯ï¼\n\nâœ¨ æ–°åŠŸèƒ½ï¼šæ”¯æŒåŠ¨æ€æŒ‡ä»¤é›†é…ç½®\n\næˆ‘å¯ä»¥å¸®æ‚¨ï¼š\nâ€¢ ä»‹ç»æ–‡ç‰©ä¿¡æ¯\nâ€¢ æ”¾å¤§æŸ¥çœ‹æ–‡ç‰©ç»†èŠ‚\nâ€¢ è¿˜åŸæ–‡ç‰©å†å²åœºæ™¯\nâ€¢ ä¸å™¨çµè¿›è¡Œäº¤äº’\nâ€¢ æŸ¥è¯¢æ–‡ç‰©å‚æ•°\n\næ–°å¢åŠŸèƒ½ï¼š\nâ€¢ åŠ¨æ€é…ç½®ä¸åŒå®¢æˆ·ç«¯çš„æŒ‡ä»¤é›†\nâ€¢ ä¼šè¯çº§æŒ‡ä»¤é›†ç®¡ç†\nâ€¢ å®æ—¶é¢„è§ˆå¯ç”¨æŒ‡ä»¤\n\nè¯·å…ˆé…ç½®æŒ‡ä»¤é›†å¹¶æ³¨å†Œä¼šè¯ï¼Œç„¶ååœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š'è®²è®²èŸ é¾™ç›–ç½çš„çº¹æ ·'");
        }

        // è·å–å½“å‰æœåŠ¡å™¨URLï¼ˆç”¨äºå¿«é€Ÿè®¿é—®æŒ‰é’®ï¼‰
        function getCurrentServerUrl() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            // ç§»é™¤æœ«å°¾çš„æ–œæ 
            return serverUrl.replace(/\/$/, '');
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            const serverUrl = getServerUrl();
            const timeout = getTimeout();
            
            try {
                showLoading('sendBtn', 'æµ‹è¯•ä¸­...');
                
                const response = await fetch(`${serverUrl}/`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(timeout * 1000)
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'ok') {
                        setConnectionStatus(true);
                        showToast('è¿æ¥æˆåŠŸï¼', 'success');
                    } else {
                        setConnectionStatus(false);
                        showToast('æœåŠ¡å™¨å“åº”å¼‚å¸¸', 'error');
                    }
                } else {
                    setConnectionStatus(false);
                    showToast(`è¿æ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                setConnectionStatus(false);
                showToast(`è¿æ¥é”™è¯¯: ${error.message}`, 'error');
            } finally {
                hideLoading('sendBtn', 'å‘é€');
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) {
                showToast('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'warning');
                return;
            }

            if (isProcessing) {
                showToast('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...', 'warning');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addUserMessage(message);
            userInput.value = '';
            
            // å‘é€è¯·æ±‚
            await processMessage(message);
        }

        // å¤„ç†æ¶ˆæ¯
        async function processMessage(message) {
            isProcessing = true;
            showLoading('sendBtn', 'å¤„ç†ä¸­...');
            
            try {
                const requestData = {
                    user_input: message,
                    client_type: getClientType(),
                    spirit_id: getSpiritId(),
                    scene_type: getSceneType()
                };

                // å¦‚æœæœ‰ä¼šè¯IDï¼Œæ·»åŠ åˆ°è¯·æ±‚å¤´
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (sessionId) {
                    headers['session-id'] = sessionId;
                }

                const response = await fetch(`${getServerUrl()}/api/agent/parse`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestData),
                    signal: AbortSignal.timeout(getTimeout() * 1000)
                });

                const result = await response.json();

                if (response.ok) {
                    handleSuccessResponse(result);
                } else {
                    handleErrorResponse(result, response.status);
                }

            } catch (error) {
                handleNetworkError(error);
            } finally {
                isProcessing = false;
                hideLoading('sendBtn', 'å‘é€');
            }
        }

        // å¤„ç†æˆåŠŸå“åº”
        function handleSuccessResponse(result) {
            if (result.code === 200 && result.data) {
                const command = result.data;
                
                // è°ƒè¯•ä¿¡æ¯ï¼šåœ¨æ§åˆ¶å°è¾“å‡ºåŸå§‹æ•°æ®
                console.log('=== APIå“åº”è°ƒè¯•ä¿¡æ¯ ===');
                console.log('å®Œæ•´å“åº”:', result);
                console.log('å‘½ä»¤æ•°æ®:', command);
                console.log('æ“ä½œæŒ‡ä»¤:', command.operation);
                console.log('æ–‡ç‰©åç§°:', command.artifact_name);
                console.log('å…³é”®è¯:', command.keywords);
                console.log('å›å¤å†…å®¹:', command.response);
                console.log('=======================');
                
                // ç›´æ¥æ˜¾ç¤ºå®Œæ•´çš„æ ‡å‡†åŒ–æŒ‡ä»¤å­—æ®µ
                let responseText = `ğŸ“‹ å®Œæ•´å“åº”å­—æ®µï¼š\n\n`;
                
                // ä¸¥æ ¼æŒ‰ç…§è¦æ±‚æ˜¾ç¤ºå››ä¸ªæ ¸å¿ƒå­—æ®µ
                responseText += `artifact_name: ${JSON.stringify(command.artifact_name)}\n`;
                responseText += `operation: ${JSON.stringify(command.operation)}\n`;
                responseText += `keywords: ${JSON.stringify(command.keywords)}\n`;
                responseText += `response: ${JSON.stringify(command.response)}\n`;
                
                // é¢å¤–æ˜¾ç¤ºå…¶ä»–æœ‰ç”¨å­—æ®µ
                if (command.artifact_id) {
                    responseText += `artifact_id: ${JSON.stringify(command.artifact_id)}\n`;
                }
                if (command.tips) {
                    responseText += `tips: ${JSON.stringify(command.tips)}\n`;
                }

                addBotMessage(responseText, command);
            } else {
                addBotMessage(`è¯·æ±‚å¤„ç†å¤±è´¥: ${result.msg || 'æœªçŸ¥é”™è¯¯'}`);
            }
        }

        // å¤„ç†é”™è¯¯å“åº”
        function handleErrorResponse(result, status) {
            let errorMsg = `è¯·æ±‚å¤±è´¥ (${status})`;
            
            if (result.msg) {
                errorMsg = result.msg;
            } else if (status === 404) {
                errorMsg = 'æœªæŸ¥è¯¢åˆ°ç›¸å…³æ–‡ç‰©æ•°æ®';
            } else if (status === 400) {
                errorMsg = 'è¯·æ±‚å‚æ•°é”™è¯¯';
            } else if (status === 401) {
                errorMsg = 'æ¥å£è®¤è¯å¤±è´¥';
            }

            addBotMessage(errorMsg);
        }

        // å¤„ç†ç½‘ç»œé”™è¯¯
        function handleNetworkError(error) {
            if (error.name === 'AbortError') {
                addBotMessage('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œç½‘ç»œè¿æ¥');
            } else {
                addBotMessage(`ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        // å‘é€ç¤ºä¾‹æ¶ˆæ¯
        function sendExample(message) {
            userInput.value = message;
            sendMessage();
        }

        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
                chatMessages.innerHTML = '';
                addWelcomeMessage();
                showToast('å¯¹è¯å·²æ¸…ç©º', 'info');
            }
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(text) {
            const messageDiv = createMessageElement('user', text);
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ·»åŠ æœºå™¨äººæ¶ˆæ¯
        function addBotMessage(text, command = null) {
            const messageDiv = createMessageElement('bot', text, command);
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
        function createMessageElement(type, text, command = null) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.innerHTML = `
                <span>${type === 'user' ? 'ç”¨æˆ·' : 'æ™ºèƒ½ä½“'}</span>
                <span>${new Date().toLocaleTimeString()}</span>
            `;

            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;

            div.appendChild(header);
            div.appendChild(content);

            // å¦‚æœæœ‰å‘½ä»¤æ•°æ®ï¼Œæ˜¾ç¤ºæ ‡å‡†åŒ–æŒ‡ä»¤
            if (command) {
                const commandDiv = document.createElement('div');
                commandDiv.className = 'command-display';
                commandDiv.innerHTML = `
                    <strong>æ ‡å‡†åŒ–æŒ‡ä»¤:</strong><br>
                    <code>${JSON.stringify(command, null, 2)}</code>
                `;
                div.appendChild(commandDiv);
            }

            return div;
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // è®¾ç½®è¿æ¥çŠ¶æ€
        function setConnectionStatus(connected) {
            isConnected = connected;
            if (connected) {
                connectionStatus.classList.add('status-connected');
                connectionText.textContent = 'å·²è¿æ¥';
                connectionText.style.color = '#27ae60';
            } else {
                connectionStatus.classList.remove('status-connected');
                connectionText.textContent = 'æœªè¿æ¥';
                connectionText.style.color = '#e74c3c';
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(btnId, text) {
            const btn = document.getElementById(btnId);
            btn.disabled = true;
            btn.textContent = text;
            btn.style.opacity = '0.7';
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading(btnId, text) {
            const btn = document.getElementById(btnId);
            btn.disabled = false;
            btn.textContent = text;
            btn.style.opacity = '1';
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            // åˆ›å»º toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            // æ·»åŠ æ ·å¼
            Object.assign(toast.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                color: 'white',
                padding: '12px 20px',
                borderRadius: '6px',
                zIndex: '10000',
                opacity: '0',
                transform: 'translateX(100%)',
                transition: 'all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                fontSize: '0.9rem',
                fontWeight: '500',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
            });

            document.body.appendChild(toast);

            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);

            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%) scale(0.8)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // è·å–é…ç½®å€¼
        function getServerUrl() {
            return document.getElementById('serverUrl').value.trim();
        }

        function getTimeout() {
            return parseInt(document.getElementById('timeout').value) || 30;
        }

        function getClientType() {
            return document.getElementById('clientType').value;
        }

        function getClientId() {
            let clientId = document.getElementById('clientId').value.trim();
            if (!clientId) {
                clientId = `${getClientType()}-client-${Date.now()}`;
                document.getElementById('clientId').value = clientId;
            }
            return clientId;
        }

        function getSpiritId() {
            return document.getElementById('spiritId').value.trim();
        }

        function getSceneType() {
            return document.getElementById('sceneType').value;
        }

        function getOperationMode() {
            return document.getElementById('operationMode').value;
        }

        function getCustomOperations() {
            const opsText = document.getElementById('customOperationList').value.trim();
            return opsText ? opsText.split('\n').filter(op => op.trim()) : [];
        }

        // ä¿å­˜è®¾ç½®åˆ° localStorage
        function saveSettings() {
            const settings = {
                serverUrl: getServerUrl(),
                timeout: getTimeout(),
                clientType: getClientType(),
                clientId: getClientId(),
                spiritId: getSpiritId(),
                sceneType: getSceneType(),
                operationMode: getOperationMode(),
                customOperations: getCustomOperations()
            };
            localStorage.setItem('museum_agent_settings', JSON.stringify(settings));
        }

        // åŠ è½½è®¾ç½®
        function loadSettings() {
            const saved = localStorage.getItem('museum_agent_settings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    if (settings.serverUrl) document.getElementById('serverUrl').value = settings.serverUrl;
                    if (settings.timeout) document.getElementById('timeout').value = settings.timeout;
                    if (settings.clientType) document.getElementById('clientType').value = settings.clientType;
                    if (settings.clientId) document.getElementById('clientId').value = settings.clientId;
                    if (settings.spiritId) document.getElementById('spiritId').value = settings.spiritId;
                    if (settings.sceneType) document.getElementById('sceneType').value = settings.sceneType;
                    if (settings.operationMode) document.getElementById('operationMode').value = settings.operationMode;
                    if (settings.customOperations && settings.customOperations.length > 0) {
                        document.getElementById('customOperationList').value = settings.customOperations.join('\n');
                    }
                } catch (e) {
                    console.warn('åŠ è½½è®¾ç½®å¤±è´¥:', e);
                }
            }
        }

        // æŒ‡ä»¤é›†é¢„è®¾é…ç½®
        const OPERATION_PRESETS = {
            'web3d': ['zoom_pattern', 'restore_scene', 'introduce', 'query_param'],
            'spirit': ['spirit_interact', 'introduce', 'query_param'],
            'mobile': ['introduce', 'query_param'],
            'api': ['zoom_pattern', 'restore_scene', 'introduce', 'spirit_interact', 'query_param'],
            'test': ['introduce', 'query_param'],
            'custom': []
        };

        const ALL_OPERATIONS = [
            'zoom_pattern',
            'restore_scene', 
            'introduce',
            'spirit_interact',
            'query_param'
        ];

        // åˆå§‹åŒ–æŒ‡ä»¤é›†é…ç½®
        function initializeOperationSets() {
            const container = document.getElementById('operationCheckboxes');
            container.innerHTML = '';
            
            ALL_OPERATIONS.forEach(op => {
                const div = document.createElement('div');
                div.style.marginBottom = '0.5rem';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `op_${op}`;
                checkbox.value = op;
                checkbox.style.marginRight = '0.5rem';
                
                const label = document.createElement('label');
                label.htmlFor = `op_${op}`;
                label.textContent = op;
                label.style.fontSize = '0.9rem';
                label.style.cursor = 'pointer';
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // æ ¹æ®å®¢æˆ·ç«¯ç±»å‹æ›´æ–°é¢„è®¾æŒ‡ä»¤é›†
        function updateOperationPresets() {
            const clientType = getClientType();
            const presetOps = OPERATION_PRESETS[clientType] || [];
            
            // é‡ç½®æ‰€æœ‰å¤é€‰æ¡†
            ALL_OPERATIONS.forEach(op => {
                const checkbox = document.getElementById(`op_${op}`);
                if (checkbox) {
                    checkbox.checked = presetOps.includes(op);
                }
            });
        }

        // åˆ‡æ¢æŒ‡ä»¤é›†é…ç½®æ¨¡å¼
        function toggleOperationConfig() {
            const mode = getOperationMode();
            const presetDiv = document.getElementById('presetOperations');
            const customDiv = document.getElementById('customOperations');
            
            if (mode === 'preset') {
                presetDiv.style.display = 'block';
                customDiv.style.display = 'none';
            } else {
                presetDiv.style.display = 'none';
                customDiv.style.display = 'block';
            }
        }

        // è·å–å½“å‰é€‰ä¸­çš„æŒ‡ä»¤é›†
        function getCurrentOperations() {
            const mode = getOperationMode();
            
            if (mode === 'preset') {
                const selectedOps = [];
                ALL_OPERATIONS.forEach(op => {
                    const checkbox = document.getElementById(`op_${op}`);
                    if (checkbox && checkbox.checked) {
                        selectedOps.push(op);
                    }
                });
                return selectedOps;
            } else {
                return getCustomOperations();
            }
        }

        // é¢„è§ˆå½“å‰æŒ‡ä»¤é›†
        function previewCommandSet() {
            const operations = getCurrentOperations();
            const clientType = getClientType();
            
            let previewText = `ğŸ“‹ å½“å‰æŒ‡ä»¤é›†é¢„è§ˆ:\n\n`;
            previewText += `å®¢æˆ·ç«¯ç±»å‹: ${clientType}\n`;
            previewText += `æŒ‡ä»¤é›†æ¨¡å¼: ${getOperationMode()}\n`;
            previewText += `å¯ç”¨æŒ‡ä»¤ (${operations.length}ä¸ª):\n`;
            
            if (operations.length > 0) {
                operations.forEach((op, index) => {
                    previewText += `  ${index + 1}. ${op}\n`;
                });
            } else {
                previewText += `  (æ— å¯ç”¨æŒ‡ä»¤)\n`;
            }
            
            previewText += `\nğŸ’¡ æç¤º: æ³¨å†Œä¼šè¯åï¼ŒLLMå°†åªä½¿ç”¨è¿™äº›æŒ‡ä»¤è¿›è¡Œè§£æ`;
            
            addBotMessage(previewText);
        }

        // æ³¨å†Œä¼šè¯
        async function registerSession() {
            const operations = getCurrentOperations();
            
            if (operations.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæŒ‡ä»¤', 'warning');
                return;
            }

            showLoading('registerBtn', 'æ³¨å†Œä¸­...');

            try {
                const registrationData = {
                    client_metadata: {
                        client_id: getClientId(),
                        client_type: getClientType(),
                        client_version: "1.0.0",
                        platform: "web-test-client",
                        capabilities: {
                            max_concurrent_requests: 3,
                            supported_scenes: ["study", "leisure", "public"],
                            preferred_response_format: "json"
                        }
                    },
                    operation_set: operations
                };

                const response = await fetch(`${getServerUrl()}/api/session/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(registrationData),
                    signal: AbortSignal.timeout(getTimeout() * 1000)
                });

                const result = await response.json();

                if (response.ok) {
                    sessionId = result.session_id;
                    sessionExpiryTime = new Date(result.expires_at);
                    
                    updateSessionDisplay('å·²æ³¨å†Œ', sessionId, sessionExpiryTime);
                    startHeartbeat();
                    
                    showToast('ä¼šè¯æ³¨å†ŒæˆåŠŸï¼', 'success');
                    addBotMessage(`âœ… ä¼šè¯æ³¨å†ŒæˆåŠŸ!

ä¼šè¯ID: ${sessionId}
è¿‡æœŸæ—¶é—´: ${sessionExpiryTime.toLocaleString()}

ç°åœ¨å‘é€çš„æ¶ˆæ¯å°†ä½¿ç”¨æ‚¨é…ç½®çš„æŒ‡ä»¤é›†è¿›è¡Œè§£æã€‚`);
                } else {
                    throw new Error(result.detail || 'æ³¨å†Œå¤±è´¥');
                }

            } catch (error) {
                showToast(`æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
                addBotMessage(`âŒ ä¼šè¯æ³¨å†Œå¤±è´¥: ${error.message}`);
            } finally {
                hideLoading('registerBtn', 'æ³¨å†Œä¼šè¯');
            }
        }

        // æ›´æ–°ä¼šè¯æ˜¾ç¤º
        function updateSessionDisplay(status, id, expiry) {
            document.getElementById('sessionStatus').textContent = status;
            document.getElementById('sessionIdDisplay').textContent = id || '-';
            document.getElementById('sessionExpiry').textContent = expiry ? expiry.toLocaleString() : '-';
            document.getElementById('sessionInfo').style.display = 'block';
        }

        // å¯åŠ¨å¿ƒè·³
        function startHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            
            heartbeatInterval = setInterval(async () => {
                if (sessionId) {
                    try {
                        await fetch(`${getServerUrl()}/api/session/heartbeat`, {
                            method: 'POST',
                            headers: {
                                'session-id': sessionId
                            },
                            signal: AbortSignal.timeout(5000)
                        });
                    } catch (error) {
                        console.warn('å¿ƒè·³å¤±è´¥:', error);
                    }
                }
            }, 5 * 60 * 1000); // æ¯5åˆ†é’Ÿå‘é€ä¸€æ¬¡å¿ƒè·³
        }

        // æ³¨é”€ä¼šè¯
        async function unregisterSession() {
            if (!sessionId) return;
            
            try {
                await fetch(`${getServerUrl()}/api/session/unregister`, {
                    method: 'DELETE',
                    headers: {
                        'session-id': sessionId
                    }
                });
            } catch (error) {
                console.warn('ä¼šè¯æ³¨é”€å¤±è´¥:', error);
            } finally {
                sessionId = null;
                sessionExpiryTime = null;
                if (heartbeatInterval) {
                    clearInterval(heartbeatInterval);
                    heartbeatInterval = null;
                }
                updateSessionDisplay('æœªæ³¨å†Œ', '-', '-');
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            unregisterSession();
        });

        // å¯¼å‡ºå‡½æ•°ä¾›å¤–éƒ¨è°ƒç”¨
        window.testConnection = testConnection;
        window.sendMessage = sendMessage;
        window.clearChat = clearChat;
        window.sendExample = sendExample;
        window.getCurrentServerUrl = getCurrentServerUrl;
        window.previewCommandSet = previewCommandSet;
        window.registerSession = registerSession;
        window.updateOperationPresets = updateOperationPresets;
        window.toggleOperationConfig = toggleOperationConfig;
        window.previewCommandSet = previewCommandSet;
        window.registerSession = registerSession;
        window.updateOperationPresets = updateOperationPresets;
        window.toggleOperationConfig = toggleOperationConfig;
    </script>
</body>
</html>