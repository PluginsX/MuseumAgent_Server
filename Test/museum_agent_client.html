<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博物馆智能体测试客户端</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #e1e5e9;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* 头部 */
        header {
            background: var(--card-bg);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 1.2rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e74c3c;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background-color: #27ae60;
        }

        .ssl-badge {
            font-size: 0.7rem;
            color: #27ae60;
            background: #d5f4e6;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #27ae60;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* 主体布局 */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            flex: 1;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* 侧边栏 */
        .sidebar {
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            max-height: 100%;
        }

        .config-section {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            flex-shrink: 0;
        }

        .config-section h3 {
            font-size: 0.9rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 0.5rem;
        }

        label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* 聊天区域 */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }

        .chat-header {
            padding: 1rem;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            min-height: 0;
            max-height: calc(100vh - 200px);
        }

        .message {
            margin-bottom: 1rem;
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            position: relative;
        }

        .message.user {
            background: var(--secondary-color);
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.bot {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            align-self: flex-start;
        }

        .message-header {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
        }

        .message-content {
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .command-display {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.8rem;
        }

        /* 输入区域 */
        .chat-input {
            padding: 1rem;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .input-group {
            flex: 1;
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        textarea {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: none;
            font-size: 1rem;
            font-family: inherit;
            min-height: 40px;
            max-height: 200px;
            line-height: 1.4;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none; /* 移动端隐藏侧边栏，可考虑改为折叠 */
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>
            <span class="status-indicator" id="connectionStatus"></span>
            博物馆智能体测试客户端
        </h1>
        <div>
            <span id="connectionText">未连接</span>
        </div>
    </header>

    <div class="container">
        <!-- 侧边栏配置 -->
        <aside class="sidebar">
            <div class="config-section">
                <h3>服务器配置</h3>
                <div class="form-group">
                    <label for="serverUrl">服务器地址 <span class="ssl-badge">支持HTTPS</span></label>
                    <input type="text" id="serverUrl" value="http://localhost:8000">
                </div>
                <div class="form-group">
                    <label for="timeout">请求超时(秒)</label>
                    <input type="number" id="timeout" value="30" min="5" max="120">
                </div>
                <button class="btn" onclick="testConnection()">测试连接</button>
                <button class="btn btn-secondary" onclick="clearChat()">清空对话</button>
            </div>

            <div class="config-section">
                <h3>客户端配置</h3>
                <div class="form-group">
                    <label for="clientType">客户端类型</label>
                    <select id="clientType">
                        <option value="test">测试客户端</option>
                        <option value="qiling">器灵</option>
                        <option value="official">官方</option>
                        <option value="third">第三方</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="spiritId">器灵ID</label>
                    <input type="text" id="spiritId" placeholder="可选">
                </div>
                <div class="form-group">
                    <label for="sceneType">场景类型</label>
                    <select id="sceneType">
                        <option value="public">公共场景</option>
                        <option value="study">学习场景</option>
                        <option value="leisure">休闲场景</option>
                    </select>
                </div>
            </div>

            <div class="config-section">
                <h3>快速访问</h3>
                <button class="btn btn-secondary" onclick="window.open(getCurrentServerUrl() + '/Control', '_blank')">管理面板</button>
                <button class="btn btn-secondary" onclick="window.open(getCurrentServerUrl() + '/docs', '_blank')">API文档</button>
            </div>

            <div class="config-section">
                <h3>配置说明</h3>
                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">各配置项说明：</p>
                <ul style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                    <li>客户端类型：用于日志统计，不影响业务逻辑</li>
                    <li>器灵ID：第三方客户端可传空，服务端不做业务处理</li>
                    <li>场景类型：study/leisure/public，默认public</li>
                </ul>
            </div>

            <div class="config-section">
                <h3>操作示例</h3>
                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">点击发送测试消息：</p>
                <button class="btn btn-secondary" onclick="sendExample('讲讲蟠龙盖罍的纹样')">纹样介绍</button>
                <button class="btn btn-secondary" onclick="sendExample('放大查看青铜鼎')">放大查看</button>
                <button class="btn btn-secondary" onclick="sendExample('还原卷体夔纹蟠龙盖罍的场景')">还原场景</button>
                <button class="btn btn-secondary" onclick="sendExample('与蟠龙盖罍的器灵对话')">器灵交互</button>
                <button class="btn btn-secondary" onclick="sendExample('查询青铜鼎的参数')">查询参数</button>
                <button class="btn btn-secondary" onclick="sendExample('测试HTTPS连接')">测试HTTPS</button>
            </div>
        </aside>

        <!-- 聊天主区域 -->
        <main class="chat-container">
            <div class="chat-header">
                <div>
                    <strong>智能体对话</strong>
                    <span style="font-size: 0.8rem; color: #666;">(测试模式)</span>
                </div>
                <div>
                    <button class="btn btn-danger" onclick="clearChat()">清空</button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- 消息将在这里动态添加 -->
            </div>

            <div class="chat-input">
                <div class="input-group">
                    <textarea 
                        id="userInput" 
                        placeholder="请输入您的问题，例如：讲讲蟠龙盖罍的纹样..." 
                        rows="3"></textarea>
                    <button class="btn" onclick="sendMessage()" id="sendBtn">发送</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 全局状态
        let isConnected = false;
        let isProcessing = false;

        // DOM 元素
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            addEventListeners();
            addWelcomeMessage();
        });

        // 添加事件监听
        function addEventListeners() {
            // 回车发送消息
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // 输入框变化时保存设置
            document.getElementById('serverUrl').addEventListener('change', saveSettings);
            document.getElementById('timeout').addEventListener('change', saveSettings);
            document.getElementById('clientType').addEventListener('change', saveSettings);
            document.getElementById('spiritId').addEventListener('change', saveSettings);
            document.getElementById('sceneType').addEventListener('change', saveSettings);
        }

        // 添加欢迎消息
        function addWelcomeMessage() {
            addBotMessage("欢迎使用博物馆智能体测试客户端！\n\n我可以帮您：\n• 介绍文物信息\n• 放大查看文物细节\n• 还原文物历史场景\n• 与器灵进行交互\n• 查询文物参数\n\n请在输入框中输入您的问题，例如：'讲讲蟠龙盖罍的纹样'");
        }

        // 获取当前服务器URL（用于快速访问按钮）
        function getCurrentServerUrl() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            // 移除末尾的斜杠
            return serverUrl.replace(/\/$/, '');
        }

        // 测试连接
        async function testConnection() {
            const serverUrl = getServerUrl();
            const timeout = getTimeout();
            
            try {
                showLoading('sendBtn', '测试中...');
                
                const response = await fetch(`${serverUrl}/`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(timeout * 1000)
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'ok') {
                        setConnectionStatus(true);
                        showToast('连接成功！', 'success');
                    } else {
                        setConnectionStatus(false);
                        showToast('服务器响应异常', 'error');
                    }
                } else {
                    setConnectionStatus(false);
                    showToast(`连接失败: ${response.status}`, 'error');
                }
            } catch (error) {
                setConnectionStatus(false);
                showToast(`连接错误: ${error.message}`, 'error');
            } finally {
                hideLoading('sendBtn', '发送');
            }
        }

        // 发送消息
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) {
                showToast('请输入消息内容', 'warning');
                return;
            }

            if (isProcessing) {
                showToast('正在处理中，请稍候...', 'warning');
                return;
            }

            // 添加用户消息
            addUserMessage(message);
            userInput.value = '';
            
            // 发送请求
            await processMessage(message);
        }

        // 处理消息
        async function processMessage(message) {
            isProcessing = true;
            showLoading('sendBtn', '处理中...');
            
            try {
                const requestData = {
                    user_input: message,
                    client_type: getClientType(),
                    spirit_id: getSpiritId(),
                    scene_type: getSceneType()
                };

                const response = await fetch(`${getServerUrl()}/api/agent/parse`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                    signal: AbortSignal.timeout(getTimeout() * 1000)
                });

                const result = await response.json();

                if (response.ok) {
                    handleSuccessResponse(result);
                } else {
                    handleErrorResponse(result, response.status);
                }

            } catch (error) {
                handleNetworkError(error);
            } finally {
                isProcessing = false;
                hideLoading('sendBtn', '发送');
            }
        }

        // 处理成功响应
        function handleSuccessResponse(result) {
            if (result.code === 200 && result.data) {
                const command = result.data;
                
                // 构建响应消息
                let responseText = `已解析您的请求：\n\n`;
                responseText += `• 文物名称: ${command.artifact_name || '未知'}\n`;
                responseText += `• 操作指令: ${command.operation || '未知'}\n`;
                responseText += `• 关键词: ${command.keywords ? command.keywords.join(', ') : '无'}\n`;
                
                if (command.tips) {
                    responseText += `\n${command.tips}`;
                }

                addBotMessage(responseText, command);
            } else {
                addBotMessage(`请求处理失败: ${result.msg || '未知错误'}`);
            }
        }

        // 处理错误响应
        function handleErrorResponse(result, status) {
            let errorMsg = `请求失败 (${status})`;
            
            if (result.msg) {
                errorMsg = result.msg;
            } else if (status === 404) {
                errorMsg = '未查询到相关文物数据';
            } else if (status === 400) {
                errorMsg = '请求参数错误';
            } else if (status === 401) {
                errorMsg = '接口认证失败';
            }

            addBotMessage(errorMsg);
        }

        // 处理网络错误
        function handleNetworkError(error) {
            if (error.name === 'AbortError') {
                addBotMessage('请求超时，请检查服务器地址和网络连接');
            } else {
                addBotMessage(`网络错误: ${error.message}`);
            }
        }

        // 发送示例消息
        function sendExample(message) {
            userInput.value = message;
            sendMessage();
        }

        // 清空对话
        function clearChat() {
            if (confirm('确定要清空所有对话记录吗？')) {
                chatMessages.innerHTML = '';
                addWelcomeMessage();
                showToast('对话已清空', 'info');
            }
        }

        // 添加用户消息
        function addUserMessage(text) {
            const messageDiv = createMessageElement('user', text);
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // 添加机器人消息
        function addBotMessage(text, command = null) {
            const messageDiv = createMessageElement('bot', text, command);
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // 创建消息元素
        function createMessageElement(type, text, command = null) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.innerHTML = `
                <span>${type === 'user' ? '用户' : '智能体'}</span>
                <span>${new Date().toLocaleTimeString()}</span>
            `;

            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;

            div.appendChild(header);
            div.appendChild(content);

            // 如果有命令数据，显示标准化指令
            if (command) {
                const commandDiv = document.createElement('div');
                commandDiv.className = 'command-display';
                commandDiv.innerHTML = `
                    <strong>标准化指令:</strong><br>
                    <code>${JSON.stringify(command, null, 2)}</code>
                `;
                div.appendChild(commandDiv);
            }

            return div;
        }

        // 滚动到底部
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 设置连接状态
        function setConnectionStatus(connected) {
            isConnected = connected;
            if (connected) {
                connectionStatus.classList.add('status-connected');
                connectionText.textContent = '已连接';
                connectionText.style.color = '#27ae60';
            } else {
                connectionStatus.classList.remove('status-connected');
                connectionText.textContent = '未连接';
                connectionText.style.color = '#e74c3c';
            }
        }

        // 显示加载状态
        function showLoading(btnId, text) {
            const btn = document.getElementById(btnId);
            btn.disabled = true;
            btn.textContent = text;
            btn.style.opacity = '0.7';
        }

        // 隐藏加载状态
        function hideLoading(btnId, text) {
            const btn = document.getElementById(btnId);
            btn.disabled = false;
            btn.textContent = text;
            btn.style.opacity = '1';
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            // 创建 toast 元素
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            // 添加样式
            Object.assign(toast.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                background: type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db',
                color: 'white',
                padding: '10px 20px',
                borderRadius: '4px',
                zIndex: '1000',
                opacity: '0',
                transform: 'translateX(100%)',
                transition: 'all 0.3s ease'
            });

            document.body.appendChild(toast);

            // 显示动画
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);

            // 自动隐藏
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // 获取配置值
        function getServerUrl() {
            return document.getElementById('serverUrl').value.trim();
        }

        function getTimeout() {
            return parseInt(document.getElementById('timeout').value) || 30;
        }

        function getClientType() {
            return document.getElementById('clientType').value;
        }

        function getSpiritId() {
            return document.getElementById('spiritId').value.trim();
        }

        function getSceneType() {
            return document.getElementById('sceneType').value;
        }

        // 保存设置到 localStorage
        function saveSettings() {
            const settings = {
                serverUrl: getServerUrl(),
                timeout: getTimeout(),
                clientType: getClientType(),
                spiritId: getSpiritId(),
                sceneType: getSceneType()
            };
            localStorage.setItem('museum_agent_settings', JSON.stringify(settings));
        }

        // 加载设置
        function loadSettings() {
            const saved = localStorage.getItem('museum_agent_settings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    if (settings.serverUrl) document.getElementById('serverUrl').value = settings.serverUrl;
                    if (settings.timeout) document.getElementById('timeout').value = settings.timeout;
                    if (settings.clientType) document.getElementById('clientType').value = settings.clientType;
                    if (settings.spiritId) document.getElementById('spiritId').value = settings.spiritId;
                    if (settings.sceneType) document.getElementById('sceneType').value = settings.sceneType;
                } catch (e) {
                    console.warn('加载设置失败:', e);
                }
            }
        }

        // 导出函数供外部调用
        window.testConnection = testConnection;
        window.sendMessage = sendMessage;
        window.clearChat = clearChat;
        window.sendExample = sendExample;
        window.getCurrentServerUrl = getCurrentServerUrl;
    </script>
</body>
</html>