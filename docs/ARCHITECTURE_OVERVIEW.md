# 博物馆智能体项目架构总览

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Web Demo    │  │  移动端 APP  │  │  小程序/TV   │          │
│  │  (浏览器)     │  │  (iOS/安卓)  │  │  (微信/TV)   │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
│         │                  │                  │                   │
│         └──────────────────┼──────────────────┘                   │
│                            │ WebSocket                            │
└────────────────────────────┼──────────────────────────────────────┘
                             │
┌────────────────────────────┼──────────────────────────────────────┐
│                         服务端层                                  │
│                            │                                       │
│  ┌─────────────────────────▼────────────────────────────┐        │
│  │              API 网关 (FastAPI)                       │        │
│  │  - 统一入口                                           │        │
│  │  - 认证授权                                           │        │
│  │  - 路由分发                                           │        │
│  └─────────────────────────┬────────────────────────────┘        │
│                            │                                       │
│  ┌─────────────────────────▼────────────────────────────┐        │
│  │         WebSocket 通信层 (src/ws/)                    │        │
│  │  - agent_handler.py      (消息处理)                   │        │
│  │  - protocol.py           (协议验证)                   │        │
│  │  - request_processor.py  (请求处理)                   │        │
│  │  - connection_manager.py (连接管理)                   │        │
│  └─────────────────────────┬────────────────────────────┘        │
│                            │                                       │
│  ┌─────────────────────────▼────────────────────────────┐        │
│  │         会话管理层 (src/session/)                     │        │
│  │  - strict_session_manager.py                          │        │
│  │    * 会话注册/注销                                     │        │
│  │    * 会话属性管理                                      │        │
│  │    * 心跳与超时                                        │        │
│  └─────────────────────────┬────────────────────────────┘        │
│                            │                                       │
│  ┌─────────────────────────▼────────────────────────────┐        │
│  │         业务服务层 (src/services/)                    │        │
│  │  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │        │
│  │  │ STT 服务     │  │ TTS 服务     │  │ LLM 服务   │ │        │
│  │  │ (语音识别)   │  │ (语音合成)   │  │ (对话生成) │ │        │
│  │  └──────────────┘  └──────────────┘  └────────────┘ │        │
│  │  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │        │
│  │  │ SRS 服务     │  │ 音频处理     │  │ 文本处理   │ │        │
│  │  │ (语义检索)   │  │ (格式转换)   │  │ (NLP处理)  │ │        │
│  │  └──────────────┘  └──────────────┘  └────────────┘ │        │
│  └─────────────────────────┬────────────────────────────┘        │
│                            │                                       │
│  ┌─────────────────────────▼────────────────────────────┐        │
│  │         核心引擎层 (src/core/)                        │        │
│  │  - command_generator.py  (指令生成)                   │        │
│  │  - dynamic_llm_client.py (LLM客户端)                  │        │
│  └─────────────────────────┬────────────────────────────┘        │
│                            │                                       │
│  ┌─────────────────────────▼────────────────────────────┐        │
│  │         数据层 (src/db/)                              │        │
│  │  - database.py           (数据库连接)                 │        │
│  │  - models.py             (数据模型)                   │        │
│  │  - client_api.py         (客户端API)                  │        │
│  └───────────────────────────────────────────────────────┘        │
└───────────────────────────────────────────────────────────────────┘
                             │
┌────────────────────────────┼──────────────────────────────────────┐
│                         外部服务层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 阿里云 LLM   │  │ 阿里云 TTS   │  │ 阿里云 STT   │          │
│  │ (通义千问)   │  │ (CosyVoice)  │  │ (语音识别)   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│  ┌──────────────┐  ┌──────────────┐                             │
│  │ SRS 检索系统 │  │ ChromaDB     │                             │
│  │ (语义检索)   │  │ (向量数据库) │                             │
│  └──────────────┘  └──────────────┘                             │
└───────────────────────────────────────────────────────────────────┘
```

---

## 🔄 核心流程

### 1. 文本对话流程
```
用户输入文本
    ↓
WebSocket 接收 (REQUEST - TEXT)
    ↓
会话验证 & 属性更新
    ↓
SRS 语义检索 (可选)
    ↓
LLM 流式生成
    ↓
TTS 流式合成 (可选)
    ↓
WebSocket 流式返回 (RESPONSE)
    ↓
客户端实时显示
```

### 2. 语音对话流程
```
用户语音输入
    ↓
WebSocket 流式接收 (REQUEST - VOICE + 二进制帧)
    ↓
STT 流式识别 → 完整文本
    ↓
SRS 语义检索 (可选)
    ↓
LLM 流式生成
    ↓
TTS 流式合成
    ↓
WebSocket 流式返回 (RESPONSE)
    ↓
客户端实时播放
```

### 3. 打断机制流程 ⭐
```
用户发送新输入
    ↓
客户端立即:
  - 停止音频播放
  - 清理本地状态
  - 异步发送 INTERRUPT
    ↓
服务端收到 INTERRUPT:
  - 设置 cancel_event
  - 立即返回 INTERRUPT_ACK
  - 异步停止任务
    ↓
LLM/TTS 检查 cancel_event:
  - 提前退出
  - 发送中断标记的最后一帧
    ↓
客户端处理新请求
```

---

## 📡 通信协议

### 客户端 → 服务端 (C→S)
| 消息类型 | 说明 | 关键字段 |
|---------|------|---------|
| REGISTER | 会话注册 | auth, platform, require_tts |
| REQUEST | 服务请求 | request_id, data_type, content |
| INTERRUPT | 打断请求 | interrupt_request_id, reason |
| SESSION_QUERY | 会话查询 | query_fields |
| HEARTBEAT_REPLY | 心跳回复 | client_status |
| SHUTDOWN | 结束会话 | reason |

### 服务端 → 客户端 (S→C)
| 消息类型 | 说明 | 关键字段 |
|---------|------|---------|
| REGISTER_ACK | 注册确认 | session_id, session_timeout_seconds |
| RESPONSE | 业务响应 | request_id, text_stream_seq, voice_stream_seq |
| INTERRUPT_ACK | 打断确认 | interrupted_request_ids, status |
| SESSION_INFO | 会话信息 | session_data |
| HEARTBEAT | 心跳 | remaining_seconds |
| ERROR | 错误 | error_code, error_msg |

---

## 🎯 核心特性

### 1. 流式处理
- **文本流**: LLM 逐字生成，实时显示
- **语音流**: TTS 逐句合成，边接收边播放
- **音频流**: STT 流式识别，降低延迟

### 2. 打断机制 ⭐
- **用户优先**: 新输入立即打断旧响应
- **乐观更新**: 客户端立即响应，不等待服务端
- **协作取消**: 通过 asyncio.Event 实现优雅停止

### 3. 会话管理
- **自动超时**: 默认 3600 秒
- **心跳保活**: 60 秒间隔
- **属性更新**: 动态修改 TTS/SRS/FunctionCalling

### 4. 语义检索 (SRS)
- **增强回答**: 基于专有资料库
- **可选开关**: 支持动态启用/禁用
- **向量检索**: ChromaDB 向量数据库

### 5. Function Calling
- **动态注册**: 客户端定义函数
- **智能调用**: LLM 自动选择函数
- **实时执行**: 客户端执行并返回结果

---

## 🔧 技术栈

### 后端
- **框架**: FastAPI + Uvicorn
- **异步**: asyncio + aiohttp
- **数据库**: SQLite + ChromaDB
- **日志**: 增强型日志系统

### 前端 (Web Demo)
- **核心**: 原生 JavaScript (ES6+)
- **通信**: WebSocket API
- **音频**: Web Audio API + AudioWorklet
- **状态**: 自定义状态管理器

### 外部服务
- **LLM**: 阿里云通义千问 (OpenAI 兼容 API)
- **TTS**: 阿里云 CosyVoice 2.0
- **STT**: 阿里云语音识别
- **SRS**: 自建语义检索系统

---

## 📊 性能指标

### 延迟
- **文本响应**: < 500ms (首字)
- **语音识别**: < 1s (流式)
- **语音合成**: < 2s (首句)
- **打断响应**: < 100ms (本地)

### 并发
- **WebSocket 连接**: 支持数百并发
- **请求处理**: 异步非阻塞
- **资源管理**: 自动清理超时会话

### 可靠性
- **错误处理**: 完善的异常捕获
- **熔断降级**: 服务故障自动降级
- **日志追踪**: 全链路日志记录

---

## 🚀 部署架构

```
┌─────────────────────────────────────────────┐
│              负载均衡 (Nginx)                │
│         - SSL/TLS 终止                       │
│         - WebSocket 代理                     │
│         - 静态资源服务                        │
└─────────────┬───────────────────────────────┘
              │
    ┌─────────┴─────────┐
    │                   │
┌───▼────┐         ┌───▼────┐
│ 服务器1 │         │ 服务器2 │
│ (主)    │         │ (备)    │
└────────┘         └────────┘
    │                   │
    └─────────┬─────────┘
              │
    ┌─────────▼─────────┐
    │   共享数据库       │
    │   - SQLite (主)    │
    │   - ChromaDB       │
    └───────────────────┘
```

---

## 📝 配置文件

### config/config.json
```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 8000,
    "debug": false
  },
  "llm": {
    "provider": "dashscope",
    "model": "qwen-plus",
    "api_key": "sk-xxx"
  },
  "tts": {
    "provider": "dashscope",
    "voice": "longxiaochun"
  },
  "stt": {
    "provider": "dashscope",
    "sample_rate": 16000
  },
  "session": {
    "timeout_seconds": 3600,
    "heartbeat_interval": 60
  }
}
```

---

## 🔍 监控与日志

### 日志类型
- **sys**: 系统级日志 (启动/关闭/错误)
- **ws**: WebSocket 通信日志
- **llm**: LLM 调用日志
- **tts**: TTS 合成日志
- **stt**: STT 识别日志
- **voice**: 语音通话日志

### 监控指标
- 活跃连接数
- 请求处理时间
- 错误率
- 资源使用率

---

## 📚 文档索引

- [通信协议](./CommunicationProtocol_CS.md) - 完整协议规范
- [会话管理](./SessionManagement_Architecture.md) - 会话架构
- [打断机制修复](./INTERRUPT_FIX.md) - 详细修复文档
- [打断机制总结](./INTERRUPT_FIX_SUMMARY.md) - 修复总结
- [API 参考](../src/api/) - API 接口文档

---

## ✨ 核心优势

1. **低延迟**: 流式处理 + 异步架构
2. **高并发**: 非阻塞 I/O + 连接池
3. **易扩展**: 模块化设计 + 服务注册
4. **强容错**: 熔断降级 + 错误恢复
5. **好体验**: 打断机制 + 实时反馈

---

**项目状态**: ✅ 生产就绪  
**最后更新**: 2026-02-18  
**版本**: v1.1.0

