# æç¤ºè¯æ„å»ºæ¨¡å—é‡æ„å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é‡æ„æ¦‚è¿°

**é‡æ„æ—¶é—´**: 2026-02-20
**é‡æ„èŒƒå›´**: æç¤ºè¯æ„å»ºåˆ°LLM APIè°ƒç”¨çš„å®Œæ•´æµç¨‹
**é‡æ„åŸåˆ™**: æ¨¡æ¿ä¸æ•°æ®å½»åº•åˆ†ç¦»ï¼Œä¸è€ƒè™‘å‘åå…¼å®¹

---

## âœ… é‡æ„æˆæœ

### 1. æ–°å¢æ¨¡å—

#### PromptTemplateEngine (æ–°å¢)
**æ–‡ä»¶**: `src/core/modules/prompt_template_engine.py`

**èŒè´£**: 
- ä»é…ç½®æ–‡ä»¶åŠ è½½æç¤ºè¯æ¨¡æ¿
- ä½¿ç”¨å˜é‡æ¸²æŸ“æ¨¡æ¿
- æ”¯æŒæ¨¡æ¿çƒ­æ›´æ–°

**æ ¸å¿ƒæ–¹æ³•**:
- `render_system_message()` - æ¸²æŸ“ç³»ç»Ÿæ¶ˆæ¯
- `render_user_message()` - æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯
- `render_functions_description()` - æ¸²æŸ“å‡½æ•°æè¿°
- `render_rag_materials()` - æ¸²æŸ“RAGææ–™

### 2. é‡æ„æ¨¡å—

#### PromptBuilder (å®Œå…¨é‡å†™)
**æ–‡ä»¶**: `src/core/modules/prompt_builder.py`

**å˜æ›´**:
- âŒ åˆ é™¤: æ‰€æœ‰ç¡¬ç¼–ç çš„æç¤ºè¯é€»è¾‘
- âœ… æ–°å¢: `build_llm_payload()` - æ„å»ºå®Œæ•´LLM APIè¯·æ±‚
- âœ… æ–°å¢: `_collect_variables()` - æ”¶é›†6ä¸ªæ ¸å¿ƒå˜é‡
- âœ… æ–°å¢: ä»é…ç½®æ–‡ä»¶è·å–APIå‚æ•°

**æ ¸å¿ƒæµç¨‹**:
```
1. ä»ä¼šè¯è·å–å˜é‡1,2,3 (è§’è‰²ã€è¦æ±‚ã€åœºæ™¯)
2. ç”Ÿæˆå˜é‡4 (å‡½æ•°æè¿°)
3. è·å–å˜é‡5 (ç”¨æˆ·è¾“å…¥)
4. æ ¼å¼åŒ–å˜é‡6 (RAGææ–™)
5. è°ƒç”¨æ¨¡æ¿å¼•æ“æ¸²æŸ“
6. ä»é…ç½®æ–‡ä»¶è·å–APIå‚æ•°
7. æ„å»ºå®Œæ•´payload
```

#### CommandGenerator (ç®€åŒ–)
**æ–‡ä»¶**: `src/core/command_generator.py`

**å˜æ›´**:
- âŒ åˆ é™¤: æ‰€æœ‰æç¤ºè¯æ„å»ºé€»è¾‘
- âŒ åˆ é™¤: `generate_standard_command()` æ–¹æ³•
- âœ… ä¿ç•™: `stream_generate()` - åè°ƒRAGã€PromptBuilderã€LLMClient
- âœ… ç®€åŒ–: ä»…ä½œä¸ºåè°ƒå™¨ï¼Œä¸å‚ä¸å…·ä½“æ„å»º

#### DynamicLLMClient (å®Œå…¨é‡å†™)
**æ–‡ä»¶**: `src/core/dynamic_llm_client.py`

**å˜æ›´**:
- âŒ åˆ é™¤: `generate_function_calling_payload()` - ç§»è‡³PromptBuilder
- âŒ åˆ é™¤: `parse_function_call_response()` - ä¸å†éœ€è¦
- âŒ åˆ é™¤: æ‰€æœ‰æç¤ºè¯æ„å»ºç›¸å…³ä»£ç 
- âœ… ä¿ç•™: `chat_completion()` - åŒæ­¥APIè°ƒç”¨
- âœ… ä¿ç•™: `chat_completion_stream()` - å¼‚æ­¥æµå¼APIè°ƒç”¨
- âœ… ç®€åŒ–: ä»…è´Ÿè´£HTTPé€šä¿¡

### 3. é…ç½®æ–‡ä»¶æ›´æ–°

#### config.json
**æ–‡ä»¶**: `config/config.json`

**æ–°å¢é…ç½®èŠ‚**:
```json
{
  "llm": {
    "prompt_templates": {
      "system_message": {
        "template": "{role_description}\n\n{response_requirements}\n\n{scene_description}\n\nå½“å‰åœºæ™¯ä¸‹æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š\n{functions_description}",
        "variables": ["role_description", "response_requirements", "scene_description", "functions_description"]
      },
      "user_message_with_rag": {
        "template": "ç”¨æˆ·çš„é—®é¢˜æ˜¯ï¼š{user_input}\n\nç›¸å…³çš„èµ„æ–™åŒ…æ‹¬ï¼š\n{retrieved_materials}",
        "variables": ["user_input", "retrieved_materials"]
      },
      "user_message_without_rag": {
        "template": "ç”¨æˆ·çš„é—®é¢˜æ˜¯ï¼š{user_input}",
        "variables": ["user_input"]
      },
      "function_item_format": {
        "template": "â€¢ {name}: {description}",
        "variables": ["name", "description"]
      },
      "rag_material_format": {
        "template": "ã€{title}ã€‘\n{content}",
        "variables": ["title", "content"]
      }
    }
  }
}
```

**åˆ é™¤é…ç½®**:
- âŒ `prompt_template` - ä¸å†ä½¿ç”¨
- âŒ `system_prompts` - ä¸å†ä½¿ç”¨
- âŒ `rag_templates` - ä¸å†ä½¿ç”¨

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡

### 6ä¸ªæ ¸å¿ƒå˜é‡

| å˜é‡ID | å˜é‡å | æ¥æº | ç”¨é€” |
|--------|--------|------|------|
| 1 | `role_description` | ä¼šè¯é…ç½® | ç³»ç»Ÿæ¶ˆæ¯ |
| 2 | `response_requirements` | ä¼šè¯é…ç½® | ç³»ç»Ÿæ¶ˆæ¯ |
| 3 | `scene_description` | ä¼šè¯é…ç½® | ç³»ç»Ÿæ¶ˆæ¯ |
| 4 | `functions_description` | è¿è¡Œæ—¶ç”Ÿæˆ | ç³»ç»Ÿæ¶ˆæ¯ |
| 5 | `user_input` | ç”¨æˆ·è¯·æ±‚ | ç”¨æˆ·æ¶ˆæ¯ |
| 6 | `retrieved_materials` | RAGæ£€ç´¢ | ç”¨æˆ·æ¶ˆæ¯ |

### æ•°æ®æµè½¬

```
ç”¨æˆ·è¯·æ±‚
  â†“
CommandGenerator (åè°ƒå™¨)
  â”œâ”€â†’ RAGæ£€ç´¢ (å˜é‡6)
  â†“
PromptBuilder (å˜é‡æ”¶é›†å™¨)
  â”œâ”€â†’ ä»ä¼šè¯è·å–å˜é‡1,2,3
  â”œâ”€â†’ ç”Ÿæˆå˜é‡4
  â”œâ”€â†’ è·å–å˜é‡5
  â”œâ”€â†’ æ ¼å¼åŒ–å˜é‡6
  â†“
PromptTemplateEngine (æ¨¡æ¿æ¸²æŸ“å™¨)
  â”œâ”€â†’ æ¸²æŸ“ç³»ç»Ÿæ¶ˆæ¯ (å˜é‡1,2,3,4)
  â”œâ”€â†’ æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯ (å˜é‡5,6)
  â†“
PromptBuilder (payloadæ„å»ºå™¨)
  â”œâ”€â†’ æ„å»ºmessagesæ•°ç»„
  â”œâ”€â†’ ä»é…ç½®è·å–APIå‚æ•°
  â”œâ”€â†’ æ·»åŠ functionså‚æ•°
  â†“
DynamicLLMClient (HTTPå®¢æˆ·ç«¯)
  â†“
LLM API
```

### æœ€ç»ˆLLM APIè¯·æ±‚ç»“æ„

```json
{
  "model": "qwen-turbo",                    // ä»é…ç½®æ–‡ä»¶è·å–
  "messages": [
    {
      "role": "system",
      "content": "ã€æ¨¡æ¿æ¸²æŸ“ï¼šå˜é‡1,2,3,4ã€‘"
    },
    {
      "role": "user",
      "content": "ã€æ¨¡æ¿æ¸²æŸ“ï¼šå˜é‡5,6ã€‘"
    }
  ],
  "functions": [...],                       // ä»ä¼šè¯è·å–
  "function_call": "auto",                  // å›ºå®šå€¼
  "temperature": 0.1,                       // ä»é…ç½®æ–‡ä»¶è·å–
  "max_tokens": 1024,                       // ä»é…ç½®æ–‡ä»¶è·å–
  "top_p": 0.1,                            // ä»é…ç½®æ–‡ä»¶è·å–
  "presence_penalty": 0,                    // ä»é…ç½®æ–‡ä»¶è·å–
  "frequency_penalty": 0,                   // ä»é…ç½®æ–‡ä»¶è·å–
  "n": 1                                    // ä»é…ç½®æ–‡ä»¶è·å–
}
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

**æµ‹è¯•æ–‡ä»¶**: `tests/test_prompt_refactor.py`

### æµ‹è¯•1: æ¨¡æ¿å¼•æ“åŸºç¡€åŠŸèƒ½ âœ…
- âœ… ç³»ç»Ÿæ¶ˆæ¯æ¸²æŸ“
- âœ… ç”¨æˆ·æ¶ˆæ¯æ¸²æŸ“ï¼ˆå¸¦RAGï¼‰
- âœ… ç”¨æˆ·æ¶ˆæ¯æ¸²æŸ“ï¼ˆä¸å¸¦RAGï¼‰
- âœ… å˜é‡æ›¿æ¢æ­£ç¡®

### æµ‹è¯•2: æç¤ºè¯æ„å»ºå™¨å®Œæ•´æµç¨‹ âœ…
- âœ… ä¼šè¯é…ç½®è¯»å–
- âœ… 6ä¸ªå˜é‡æ”¶é›†
- âœ… æ¨¡æ¿æ¸²æŸ“
- âœ… Payloadç»“æ„éªŒè¯
- âœ… APIå‚æ•°æ­£ç¡®è®¾ç½®

### æµ‹è¯•3: ä¸å¸¦RAGçš„åœºæ™¯ âœ…
- âœ… æ— RAGæ—¶ä½¿ç”¨æ­£ç¡®æ¨¡æ¿
- âœ… æ— å‡½æ•°æ—¶ä¸æ·»åŠ functionså‚æ•°
- âœ… Payloadç»“æ„æ­£ç¡®

**æµ‹è¯•è¾“å‡ºç¤ºä¾‹**:
```
ç³»ç»Ÿæ¶ˆæ¯:
------------------------------------------------------------
ä½ å«éŸ©ç«‹ï¼Œæ˜¯è¾½å®çœåšç‰©é¦†çš„æ™ºèƒ½è®²è§£å‘˜ã€‚æ€§åˆ«ç”·ï¼Œæ€§æ ¼çƒ­æƒ…é˜³å…‰å¼€æœ—å¥è°ˆã€‚

åŸºäºå½“å‰æ‰€å¤„çš„åœºæ™¯ä»¥åŠåœºæ™¯çš„å†…å®¹ï¼Œç»¼åˆç›¸å…³ææ–™ï¼Œå›ç­”ç”¨æˆ·çš„æé—®ã€‚

å½“å‰æ‰€å¤„çš„æ˜¯'è¥¿å‘¨é’é“œå™¨é€ å‹çº¹æ ·å±•ç¤ºåŒº'ï¼Œä¸»è¦å†…å®¹ä¸ºè¥¿å‘¨é’é“œå™¨è¡¨é¢åŒ…å«çš„å„ç§çº¹æ ·çš„å›¾å½¢å’Œå¯“æ„å±•ç¤ºã€‚
è¯·æ³¨æ„ç»“åˆå±•å“çš„å†å²èƒŒæ™¯å’Œæ–‡åŒ–å†…æ¶µè¿›è¡Œè®²è§£ã€‚

å½“å‰åœºæ™¯ä¸‹æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š
â€¢ move_camera: ç§»åŠ¨æ‘„åƒæœºåˆ°æŒ‡å®šä½ç½®
â€¢ play_music: æ’­æ”¾æŒ‡å®šçš„èƒŒæ™¯éŸ³ä¹

ç”¨æˆ·æ¶ˆæ¯:
------------------------------------------------------------
ç”¨æˆ·çš„é—®é¢˜æ˜¯ï¼šé¥•é¤®çº¹æ˜¯ä»€ä¹ˆå¯“æ„ï¼Ÿ

ç›¸å…³çš„èµ„æ–™åŒ…æ‹¬ï¼š
ã€é¥•é¤®çº¹ä»‹ç»ã€‘
é¥•é¤®çº¹æ˜¯é’é“œå™¨ä¸Šæœ€å¸¸è§çš„çº¹æ ·ä¹‹ä¸€ï¼Œè±¡å¾ç€æƒåŠ›å’Œå¨ä¸¥ã€‚

ã€é¥•é¤®çº¹çš„å†å²ã€‘
é¥•é¤®çº¹èµ·æºäºå•†ä»£ï¼Œåœ¨è¥¿å‘¨æ—¶æœŸè¾¾åˆ°é¼ç››ã€‚
```

---

## ğŸ“Š é‡æ„å¯¹æ¯”

### ä»£ç è¡Œæ•°å˜åŒ–

| æ¨¡å— | é‡æ„å‰ | é‡æ„å | å˜åŒ– |
|------|--------|--------|------|
| prompt_builder.py | 150è¡Œ | 180è¡Œ | +30è¡Œ |
| dynamic_llm_client.py | 600è¡Œ | 150è¡Œ | -450è¡Œ |
| command_generator.py | 200è¡Œ | 80è¡Œ | -120è¡Œ |
| prompt_template_engine.py | 0è¡Œ | 200è¡Œ | +200è¡Œ |
| **æ€»è®¡** | **950è¡Œ** | **610è¡Œ** | **-340è¡Œ (-36%)** |

### èŒè´£åˆ†ç¦»

| èŒè´£ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| æ¨¡æ¿ç®¡ç† | åˆ†æ•£åœ¨å„æ¨¡å— | PromptTemplateEngine |
| å˜é‡æ”¶é›† | DynamicLLMClient | PromptBuilder |
| æç¤ºè¯æ¸²æŸ“ | DynamicLLMClient | PromptTemplateEngine |
| Payloadæ„å»º | DynamicLLMClient | PromptBuilder |
| APIè°ƒç”¨ | DynamicLLMClient | DynamicLLMClient |
| æµç¨‹åè°ƒ | CommandGenerator | CommandGenerator |

---

## âœ¨ é‡æ„ä¼˜åŠ¿

### 1. çµæ´»æ€§æå‡
- âœ… ä¿®æ”¹æç¤ºè¯ç»“æ„æ— éœ€æ”¹ä»£ç ï¼Œåªéœ€æ”¹é…ç½®
- âœ… æ”¯æŒA/Bæµ‹è¯•ä¸åŒçš„æç¤ºè¯æ¨¡æ¿
- âœ… å¯ä»¥ä¸ºä¸åŒåœºæ™¯å®šä¹‰ä¸åŒæ¨¡æ¿

### 2. å¯ç»´æŠ¤æ€§æå‡
- âœ… èŒè´£æ¸…æ™°ï¼Œæ¯ä¸ªæ¨¡å—å•ä¸€èŒè´£
- âœ… ä»£ç é‡å‡å°‘36%
- âœ… æ˜“äºç†è§£å’Œä¿®æ”¹

### 3. å¯æµ‹è¯•æ€§æå‡
- âœ… æ¯ä¸ªæ¨¡å—å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- âœ… æ¨¡æ¿æ¸²æŸ“å¯ä»¥å•ç‹¬éªŒè¯
- âœ… å˜é‡æ”¶é›†å¯ä»¥å•ç‹¬æµ‹è¯•

### 4. å¯æ‰©å±•æ€§æå‡
- âœ… æ–°å¢å˜é‡åªéœ€ä¿®æ”¹é…ç½®å’Œæ”¶é›†é€»è¾‘
- âœ… æ–°å¢æ¨¡æ¿ç±»å‹åªéœ€æ·»åŠ é…ç½®
- âœ… æ”¯æŒæ¨¡æ¿ç‰ˆæœ¬ç®¡ç†

### 5. å¯è§‚æµ‹æ€§æå‡
- âœ… æ¯ä¸ªæ­¥éª¤éƒ½æœ‰è¯¦ç»†æ—¥å¿—
- âœ… å¯ä»¥è¿½è¸ªæ¯ä¸ªå˜é‡çš„æ¥æº
- âœ… å¯ä»¥å®¡è®¡æ¨¡æ¿ä½¿ç”¨å†å²

---

## ğŸ”„ è¿ç§»æŒ‡å—

### å¯¹äºå¼€å‘è€…

**æ—§ä»£ç **:
```python
# æ—§æ–¹å¼ï¼šDynamicLLMClientè´Ÿè´£ä¸€åˆ‡
payload = llm_client.generate_function_calling_payload(
    session_id, user_input, scene_type, rag_instruction, functions
)
response = llm_client._chat_completions_with_functions(payload)
```

**æ–°ä»£ç **:
```python
# æ–°æ–¹å¼ï¼šèŒè´£åˆ†ç¦»
# 1. PromptBuilderæ„å»ºpayload
payload = prompt_builder.build_llm_payload(
    session_id, user_input, rag_context
)

# 2. LLMClientä»…è´Ÿè´£APIè°ƒç”¨
response = llm_client.chat_completion(payload)
```

### å¯¹äºé…ç½®ç®¡ç†å‘˜

**æ—§é…ç½®** (å·²åˆ é™¤):
```json
{
  "llm": {
    "prompt_template": "ç¡¬ç¼–ç çš„æ¨¡æ¿...",
    "system_prompts": {...}
  }
}
```

**æ–°é…ç½®**:
```json
{
  "llm": {
    "prompt_templates": {
      "system_message": {
        "template": "{role_description}\n\n{response_requirements}...",
        "variables": [...]
      }
    }
  }
}
```

---

## ğŸ“ åç»­ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸ (1-2å‘¨)
1. âœ… æ·»åŠ æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†
2. âœ… æ”¯æŒæ¨¡æ¿çƒ­æ›´æ–°
3. âœ… æ·»åŠ æ¨¡æ¿éªŒè¯å·¥å…·

### ä¸­æœŸ (1-2æœˆ)
1. âœ… æ”¯æŒå¤šè¯­è¨€æ¨¡æ¿
2. âœ… å®ç°æ¨¡æ¿A/Bæµ‹è¯•æ¡†æ¶
3. âœ… æ·»åŠ æ¨¡æ¿æ€§èƒ½ç›‘æ§

### é•¿æœŸ (3-6æœˆ)
1. âœ… æ¨¡æ¿å¯è§†åŒ–ç¼–è¾‘å™¨
2. âœ… æ™ºèƒ½æ¨¡æ¿æ¨è
3. âœ… åŸºäºåé¦ˆçš„æ¨¡æ¿ä¼˜åŒ–

---

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ
1. **æ¨¡æ¿ä¸æ•°æ®åˆ†ç¦»** - æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼Œå¸¦æ¥å·¨å¤§çµæ´»æ€§
2. **å•ä¸€èŒè´£åŸåˆ™** - æ¯ä¸ªæ¨¡å—èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
3. **é…ç½®é©±åŠ¨** - é…ç½®æ–‡ä»¶æ§åˆ¶è¡Œä¸ºï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
4. **å……åˆ†æµ‹è¯•** - æµ‹è¯•è¦†ç›–æ‰€æœ‰åœºæ™¯ï¼Œç¡®ä¿é‡æ„è´¨é‡

### æ³¨æ„äº‹é¡¹
1. **ä¸è€ƒè™‘å…¼å®¹** - å½»åº•é‡æ„ï¼Œä¸ä¿ç•™æ—§ä»£ç 
2. **é…ç½®æ–‡ä»¶æ¸…ç†** - åˆ é™¤æœªä½¿ç”¨çš„é…ç½®é¡¹
3. **æ–‡æ¡£åŒæ­¥æ›´æ–°** - ç¡®ä¿æ–‡æ¡£ä¸ä»£ç ä¸€è‡´
4. **å……åˆ†æµ‹è¯•** - é‡æ„åå¿…é¡»å…¨é¢æµ‹è¯•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é‡æ„è®¡åˆ’](./PROMPT_REFACTOR_PLAN.md)
- [æ¶æ„åˆ†æ](./PROMPT_ARCHITECTURE_ANALYSIS.md)
- [æµ‹è¯•è„šæœ¬](../tests/test_prompt_refactor.py)
- [é…ç½®æ–‡ä»¶](../config/config.json)

---

## âœ… é‡æ„æ£€æŸ¥æ¸…å•

- [x] åˆ›å»º PromptTemplateEngine æ¨¡å—
- [x] é‡å†™ PromptBuilder æ¨¡å—
- [x] ç®€åŒ– CommandGenerator æ¨¡å—
- [x] é‡å†™ DynamicLLMClient æ¨¡å—
- [x] æ›´æ–°é…ç½®æ–‡ä»¶
- [x] åˆ é™¤æ—§ä»£ç å’Œé…ç½®
- [x] ç¼–å†™æµ‹è¯•è„šæœ¬
- [x] è¿è¡Œæµ‹è¯•éªŒè¯
- [x] æ›´æ–°æ–‡æ¡£
- [x] åˆ›å»ºé‡æ„æŠ¥å‘Š

---

**é‡æ„å®Œæˆæ—¶é—´**: 2026-02-20 21:08
**é‡æ„çŠ¶æ€**: âœ… å®Œæˆ
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡

