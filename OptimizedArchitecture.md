# MuseumAgent 服务端优化架构设计文档

## 1. 设计理念

### 1.1 核心原则
- **高内聚**：每个模块专注单一职责，功能紧密相关
- **低耦合**：模块间通过清晰接口通信，减少相互依赖
- **模块化**：系统划分为独立可替换的模块
- **配置驱动**：所有行为由配置文件驱动，支持运行时调整
- **职能单一**：每个服务只负责特定功能领域
- **速度优先**：采用异步非阻塞架构，优化关键路径

### 1.2 通信协议原则
- **客户端通信**：所有与客户端的通信均使用项目特定协议
- **阿里云通信**：TTS和STT严格使用阿里云官方要求的DashScope SDK
- **LLM通信**：使用OpenAI兼容API标准
- **SRS通信**：严格遵守SRS的通信要求和API规范

### 1.3 架构风格
- 微服务架构
- 事件驱动
- 异步非阻塞
- 面向服务

## 2. 整体架构设计

### 2.1 分层架构
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           表现层                                        │
│  • Web演示 (客户端)                                                      │
│  • 控制面板 (管理端)                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API网关层                                      │
│  • 请求路由与负载均衡                                                     │
│  • 认证与授权                                                             │
│  • 限流与节流                                                             │
│  • 协议转换 (HTTP/WS/GRPC)                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ 文本服务        │ │ 音频服务        │ │ 语音通话        │ │ 会话服务        │
│                 │ │                 │ │ 服务            │ │                 │
│ • 文本解析      │ │ • STT处理       │ │ • 实时          │ │ • 会话管理      │
│ • 流式生成      │ │ • TTS处理       │ │   音频流        │ │ • 认证令牌      │
│ • LLM集成       │ │ • 音频格式      │ │ • STT+TTS同步   │ │ • 生命周期      │
│ • RAG检索       │ │   转换          │ │ • 缓冲区管理    │ │ • 验证          │
└─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘
         │                    │                     │                  │
         └────────────────────┼─────────────────────┼──────────────────┘
                              ▼                     ▼
                    ┌─────────────────┐    ┌─────────────────┐
                    │ LLM服务         │    │ SRS服务         │
                    │                 │    │                 │
                    │ • LLM调用       │    │ • 语义          │
                    │ • 流式响应      │    │   检索          │
                    │ • 函数调用      │    │ • 向量搜索      │
                    │ • 响应生成      │    │ • 上下文准备    │
                    │ • OpenAI兼容API │    │ • SRS标准API    │
                    └─────────────────┘    └─────────────────┘
```

### 2.2 服务治理
- 服务注册与发现
- 配置中心
- 熔断与降级
- 监控与告警

## 3. 微服务设计

### 3.1 文本处理服务
**职责**：处理文本输入，生成文本响应
**接口**：
- `POST /api/text/process` - 处理文本输入
- `WS /ws/text/stream` - 流式文本生成
- `POST /api/text/batch` - 批量处理文本

**内部组件**：
- Parser：解析用户输入
- RAGProcessor：检索增强生成
- LLMInterface：LLM调用接口
- ResponseFormatter：响应格式化

**通信协议**：
- 与客户端：项目特定协议
- 与LLM服务：OpenAI兼容API标准
- 与SRS服务：SRS标准API

### 3.2 音频处理服务
**职责**：处理预录制音频，执行STT和TTS
**接口**：
- `POST /api/audio/stt` - 音频转文本
- `POST /api/audio/tts` - 文本转音频
- `POST /api/audio/process` - 音频处理全流程

**内部组件**：
- AudioDecoder：音频解码
- STTProvider：语音识别提供商（使用阿里云DashScope SDK）
- TTSEncoder：文本转语音编码（使用阿里云DashScope SDK）
- AudioEncoder：音频编码

**通信协议**：
- 与客户端：项目特定协议
- 与阿里云：严格使用DashScope官方SDK标准

### 3.3 语音通话服务
**职责**：处理实时语音通话
**接口**：
- `WS /ws/voice/call` - 实时语音通话
- `POST /api/voice/start` - 启动通话
- `POST /api/voice/end` - 结束通话

**内部组件**：
- AudioManager：音频管理
- RealTimeSTT：实时语音识别（使用阿里云DashScope SDK）
- RealTimeTTS：实时文本转语音（使用阿里云DashScope SDK）
- BufferManager：缓冲区管理

**通信协议**：
- 与客户端：项目特定协议
- 与阿里云：严格使用DashScope官方SDK标准

### 3.4 会话管理服务
**职责**：管理用户会话和认证
**接口**：
- `POST /api/auth/login` - 用户登录
- `GET /api/auth/me` - 获取用户信息
- `GET /api/session/validate/{session_id}` - 验证会话
- `DELETE /api/session/{session_id}` - 注销会话

**内部组件**：
- TokenManager：令牌管理
- SessionStore：会话存储
- Validator：验证器
- Cleaner：清理器

**通信协议**：
- 与客户端：项目特定协议
- 与内部服务：内部API协议

## 4. 配置管理系统

### 4.1 配置层级
```
┌─────────────────────────────────────────────────────────────────────┐
│                    配置层级架构                                     │
├─────────────────────────────────────────────────────────────────────┤
│ 1. 全局配置 (config/global.json)                                  │
│    • 服务器范围设置                                                │
│    • 安全策略                                                      │
│    • 日志配置                                                      │
│ 2. 服务配置 (config/services/*.json)                             │
│    • 服务特定设置                                                  │
│    • 资源限制                                                      │
│    • 超时值                                                        │
│ 3. 运行时配置 (通过API/环境变量)                                  │
│    • 功能标志                                                      │
│    • 性能调优                                                      │
│    • 调试模式                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 配置结构
```json
{
  "global": {
    "server": {
      "host": "0.0.0.0",
      "port": 8000,
      "workers": 4,
      "cors_allow_origins": ["*"],
      "request_timeout": 30
    },
    "logging": {
      "level": "INFO",
      "format": "json",
      "handlers": ["console", "file"],
      "file_path": "./logs/app.log"
    },
    "security": {
      "jwt_secret": "secret-key",
      "rate_limit": {
        "requests": 100,
        "window_seconds": 60
      }
    }
  },
  "services": {
    "text_processing": {
      "concurrency": 10,
      "timeout": 30,
      "enable_cache": true,
      "cache_ttl_seconds": 300
    },
    "audio_processing": {
      "max_duration_seconds": 60,
      "supported_formats": ["mp3", "wav", "pcm", "opus"],
      "stt_provider": "aliyun",
      "tts_provider": "aliyun",
      "buffer_size": 1024
    },
    "voice_call": {
      "max_concurrent_calls": 5,
      "buffer_size": 1024,
      "echo_cancellation": true,
      "noise_suppression": true
    }
  },
  "external_apis": {
    "llm": {
      "provider": "openai_compatible",
      "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
      "api_key": "sk-xxx",
      "model": "qwen-turbo",
      "timeout": 60,
      "retry_attempts": 3,
      "max_tokens": 1024
    },
    "stt": {
      "provider": "aliyun",
      "sdk_type": "dashscope-official-sdk",  /* 严格使用阿里云官方DashScope SDK */
      "model": "paraformer-realtime-v2",
      "api_key": "sk-xxx",
      "format": "pcm",
      "sample_rate": 16000,
      "language": "zh-CN",
      "timeout": 30
    },
    "tts": {
      "provider": "aliyun",
      "sdk_type": "dashscope-official-sdk",  /* 严格使用阿里云官方DashScope SDK */
      "model": "cosyvoice-v3-plus",
      "api_key": "sk-xxx",
      "voice": "longanhuan",
      "format": "mp3",
      "sample_rate": 22050,
      "timeout": 30
    },
    "srs": {
      "base_url": "http://localhost:12315/api/v1",
      "api_key": "",
      "timeout": 30,
      "communication_protocol": "srs-standard-api",  /* 遵循SRS通信要求 */
      "search_params": {
        "top_k": 3,
        "threshold": 0.35
      }
    }
  }
}
```

## 5. 性能优化策略

### 5.1 异步非阻塞架构
```
┌─────────────────────────────────────────────────────────────────────┐
│                    事件循环架构                                     │
├─────────────────────────────────────────────────────────────────────┤
│ • 单线程事件循环                                                  │
│ • 基于协程的并发                                                  │
│ • 非阻塞I/O操作                                                   │
│ • 高效的资源利用                                                  │
│ • 基于FastAPI + Uvicorn                                          │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 连接池管理
- WebSocket连接池：复用WebSocket连接
- HTTP连接池：复用到外部API的连接
- 数据库连接池：高效管理数据库连接

### 5.3 缓存策略
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   L1 缓存       │    │   L2 缓存       │    │   L3 缓存       │
│   (内存)        │    │   (Redis)       │    │   (外部)        │
│                 │    │                 │    │                 │
│ • 会话数据      │    │ • API响应       │    │ • 大对象        │
│ • 令牌          │    │ • STT结果       │    │ • 静态资源      │
│ • 临时缓冲区    │    │ • TTS结果       │    │ • 预计算结果    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 5.4 音频流处理优化
- 流水线处理：音频接收、STT、LLM、TTS并行执行
- 增量处理：实时处理音频片段而非等待完整音频
- 零拷贝传输：减少内存复制开销
- 智能缓冲：自适应缓冲区大小

### 5.5 并发处理模型
```
┌─────────────────────────────────────────────────────────────────────┐
│                   并发处理架构                                      │
├─────────────────────────────────────────────────────────────────────┤
│ 主事件循环: API网关 + 会话管理                                    │
│ ├── 工作池: 文本处理 (CPU密集型)                                  │
│ ├── 音频工作器: STT/TTS处理 (I/O密集型)                          │
│ ├── 语音工作器: 实时音频 (实时处理)                              │
│ └── 外部API池: LLM/SRS调用 (异步I/O)                            │
└─────────────────────────────────────────────────────────────────────┘
```

## 6. 错误处理与容错

### 6.1 错误分类
- **客户端错误**：输入验证失败、认证失败
- **服务端错误**：内部错误、外部API故障
- **网络错误**：连接超时、网络中断
- **资源错误**：内存不足、磁盘空间不足

### 6.2 容错机制
- **重试机制**：对外部API调用实现指数退避重试
- **熔断器**：防止级联故障
- **降级策略**：关键功能失效时的备选方案
- **健康检查**：定期检查服务状态

## 7. 监控与运维

### 7.1 性能指标
- **QPS**：每秒查询率
- **延迟**：请求处理时间分布
- **错误率**：错误请求占比
- **资源使用**：CPU、内存、网络

### 7.2 日志策略
- **结构化日志**：JSON格式便于分析
- **分级日志**：DEBUG/INFO/WARNING/ERROR
- **审计日志**：安全相关操作记录
- **性能日志**：关键路径耗时统计

### 7.3 告警机制
- **阈值告警**：性能指标超过阈值
- **异常告警**：错误率异常升高
- **容量告警**：资源使用率过高
- **业务告警**：核心功能异常

## 8. 部署架构

### 8.1 容器化部署
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   文本服务      │    │   音频服务      │    │  语音通话服务   │
│   (Docker)      │    │   (Docker)      │    │   (Docker)      │
│  • 自动扩展     │    │  • 自动扩展     │    │  • 自动扩展     │
│  • 健康检查     │    │  • 健康检查     │    │  • 健康检查     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                    │                     │
         └────────────────────┼─────────────────────┘
                              ▼
                    ┌─────────────────┐
                    │   API网关       │
                    │   (Kubernetes)  │
                    │  • 负载均衡     │
                    │  • SSL终止     │
                    │  • 认证        │
                    └─────────────────┘
```

### 8.2 高可用设计
- **多副本部署**：关键服务多实例运行
- **负载均衡**：请求分发到健康实例
- **故障转移**：自动切换到备用实例
- **数据备份**：定期备份关键数据

## 9. 安全设计

### 9.1 认证授权
- **JWT Token**：无状态认证
- **RBAC**：基于角色的访问控制
- **API Key**：服务间调用认证
- **OAuth2**：第三方集成认证

### 9.2 数据安全
- **传输加密**：TLS/SSL保护数据传输
- **存储加密**：敏感数据加密存储
- **访问控制**：细粒度权限控制
- **审计追踪**：操作日志记录

## 10. 扩展性设计

### 10.1 水平扩展
- **无状态服务**：支持水平扩展
- **分布式缓存**：共享状态管理
- **负载均衡**：自动分发请求
- **服务发现**：动态服务注册

### 10.2 垂直扩展
- **资源配置**：可调整CPU/内存
- **连接池**：可调整连接数
- **并发数**：可调整处理并发
- **缓存容量**：可调整缓存大小

---

*本文档定义了MuseumAgent服务端的优化架构，旨在提供高性能、高可用、易维护的系统架构。*