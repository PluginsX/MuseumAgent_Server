# 博物馆智能体服务器 - 优化架构版

基于优化架构设计的全新重构版本，采用高内聚、低耦合、模块化、配置驱动的设计理念。

## 架构特点

### 1. 高内聚、低耦合
- 每个服务模块职责单一，专注于特定功能
- 服务间通过明确定义的接口通信
- 减少模块间的依赖关系

### 2. 模块化设计
- API网关层：统一入口、认证、路由
- 业务服务层：文本、音频、语音通话等独立服务
- 公共组件层：配置管理、性能优化、容错处理

### 3. 配置驱动
- 所有服务配置集中管理
- 支持运行时配置更新
- 环境适应性强

### 4. 性能优化
- 多级缓存策略
- 异步并发处理
- 连接池管理

### 5. 容错机制
- 熔断器模式防止雪崩
- 降级策略保证核心功能
- 重试与退避机制

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    客户端请求                               │
└───────────────────────┬─────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                    API网关                                  │
│  - 统一入口点                                              │
│  - 认证与授权                                              │
│  - 请求路由                                                │
│  - 协议转换                                                │
└───────────────────────┬─────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                   业务服务层                                 │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 文本处理服务                                            │ │
│  │ - LLM集成 (OpenAI兼容API)                              │ │
│  │ - SRS集成 (语义检索)                                   │ │
│  │ - Function Calling                                     │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 音频处理服务                                            │ │
│  │ - STT服务 (阿里云)                                     │ │
│  │ - TTS服务 (阿里云)                                     │ │
│  │ - 音频格式转换                                          │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 语音通话服务                                            │ │
│  │ - 实时语音流处理                                        │ │
│  │ - STT/TTS并发调用                                       │ │
│  │ - 通话状态管理                                          │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 会话管理服务                                            │ │
│  │ - 用户认证                                              │ │
│  │ - Token管理                                             │ │
│  │ - 会话状态跟踪                                          │ │
│  └─────────────────────────────────────────────────────────┘ │
└───────────────────────┬─────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                   外部服务集成                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 阿里云LLM服务 (OpenAI兼容API)                           │ │
│  │ - qwen-turbo 等模型                                    │ │
│  │ - 函数调用支持                                          │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 阿里云TTS/STT服务 (DashScope SDK)                       │ │
│  │ - 语音合成与识别                                        │ │
│  │ - 实时流式处理                                          │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ SRS语义检索系统                                         │ │
│  │ - 博物馆资料检索                                        │ │
│  │ - 向量数据库查询                                        │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 功能特性

### 1. 文本对话
- 支持普通文本对话
- 支持Function Calling
- 集成SRS语义检索增强回答准确性

### 2. 语音功能
- 预录制语音消息处理
- 实时语音通话（流式STT/TTS）
- 语音播报功能

### 3. 会话管理
- 用户认证与授权
- Token管理和刷新
- 会话状态跟踪

### 4. 性能优化
- LRU缓存机制
- 异步并发处理
- 连接池复用

### 5. 容错处理
- 熔断器防雪崩
- 自动降级策略
- 重试与退避机制

## 通信协议

### 服务端与客户端通信
- 采用项目特定协议
- 支持WebSocket实时通信
- JSON格式数据交换

### 服务端与外部服务通信
- **LLM服务**: OpenAI兼容API
- **TTS/STT服务**: 阿里云DashScope SDK标准
- **SRS服务**: SRS标准API

## 快速开始

### 1. 安装依赖
```bash
pip install fastapi uvicorn aiohttp pyjwt passlib[bcrypt] python-multipart
```

### 2. 配置文件
编辑 `config/config.json` 文件，配置各项服务参数。

### 3. 启动服务
```bash
python main.py
```

### 4. 运行测试
```bash
python -m pytest tests/system_test.py
```

## 配置说明

### 服务器配置 (server)
- `host`: 服务器主机地址
- `port`: 服务器端口
- `debug`: 调试模式开关
- `cors_allow_origins`: 跨域允许域名

### LLM服务配置 (llm)
- `base_url`: LLM服务基础URL
- `api_key`: API密钥
- `model`: 使用的模型名称
- `parameters`: 模型参数配置

### TTS服务配置 (tts)
- `api_key`: TTS服务API密钥
- `model`: TTS模型名称
- `parameters`: TTS参数配置

### STT服务配置 (stt)
- `api_key`: STT服务API密钥
- `model`: STT模型名称
- `parameters`: STT参数配置

### SRS服务配置 (semantic_retrieval)
- `base_url`: SRS服务基础URL
- `api_key`: API密钥
- `timeout`: 请求超时时间
- `search_params`: 搜索参数配置

## 项目结构

```
MuseumAgent_Server/
├── main.py                 # 主程序入口
├── config/
│   └── config.json         # 配置文件
├── src/
│   ├── gateway/
│   │   └── api_gateway.py  # API网关实现
│   ├── services/           # 业务服务模块
│   │   ├── text_processing_service.py
│   │   ├── audio_processing_service.py
│   │   ├── voice_call_service.py
│   │   ├── session_service.py
│   │   ├── llm_service.py
│   │   ├── srs_service.py
│   │   ├── tts_service.py
│   │   └── stt_service.py
│   ├── common/             # 公共组件
│   │   ├── log_utils.py
│   │   ├── log_formatter.py
│   │   ├── config_manager.py
│   │   ├── performance_optimizer.py
│   │   └── fault_tolerance.py
│   └── services/
│       └── registry.py     # 服务注册中心
├── client/                 # 客户端代码
│   └── web/
│       └── Demo/           # Web演示界面
├── tests/                  # 测试代码
│   └── system_test.py      # 系统测试用例
├── docs/                   # 文档
│   ├── NewOptimizedArchitecture.mermaid  # 架构图
│   └── OptimizedArchitecture.md          # 架构文档
└── README.md
```

## 开发规范

### 代码风格
- 遵循PEP 8编码规范
- 使用类型注解提高代码可读性
- 统一日志格式便于调试

### 模块设计
- 每个服务模块职责单一
- 接口设计清晰明确
- 错误处理完善

### 配置管理
- 敏感信息不硬编码
- 配置文件版本控制
- 支持环境变量覆盖

## 部署建议

### 生产环境
- 使用反向代理(Nginx)
- 配置SSL证书
- 设置适当的资源限制
- 启用日志轮转

### 监控与运维
- 配置健康检查端点
- 设置性能监控
- 定期备份配置文件
- 监控服务状态

## 版权声明

本项目仅供学习和研究使用。